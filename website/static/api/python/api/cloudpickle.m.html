<!doctype html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />

    <title>heronpy.api.cloudpickle API documentation</title>
    <meta name="description" content="This class is defined to override standard pickle functionality
The goals of it follow:
-Serialize l..." />

  <link href='http://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300' rel='stylesheet' type='text/css'>
  
  <style type="text/css">
  
* {
  box-sizing: border-box;
}
/*! normalize.css v1.1.1 | MIT License | git.io/normalize */

/* ==========================================================================
   HTML5 display definitions
   ========================================================================== */

/**
 * Correct `block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

article,
aside,
details,
figcaption,
figure,
footer,
header,
hgroup,
main,
nav,
section,
summary {
    display: block;
}

/**
 * Correct `inline-block` display not defined in IE 6/7/8/9 and Firefox 3.
 */

audio,
canvas,
video {
    display: inline-block;
    *display: inline;
    *zoom: 1;
}

/**
 * Prevent modern browsers from displaying `audio` without controls.
 * Remove excess height in iOS 5 devices.
 */

audio:not([controls]) {
    display: none;
    height: 0;
}

/**
 * Address styling not present in IE 7/8/9, Firefox 3, and Safari 4.
 * Known issue: no IE 6 support.
 */

[hidden] {
    display: none;
}

/* ==========================================================================
   Base
   ========================================================================== */

/**
 * 1. Prevent system color scheme's background color being used in Firefox, IE,
 *    and Opera.
 * 2. Prevent system color scheme's text color being used in Firefox, IE, and
 *    Opera.
 * 3. Correct text resizing oddly in IE 6/7 when body `font-size` is set using
 *    `em` units.
 * 4. Prevent iOS text size adjust after orientation change, without disabling
 *    user zoom.
 */

html {
    background: #fff; /* 1 */
    color: #000; /* 2 */
    font-size: 100%; /* 3 */
    -webkit-text-size-adjust: 100%; /* 4 */
    -ms-text-size-adjust: 100%; /* 4 */
}

/**
 * Address `font-family` inconsistency between `textarea` and other form
 * elements.
 */

html,
button,
input,
select,
textarea {
    font-family: sans-serif;
}

/**
 * Address margins handled incorrectly in IE 6/7.
 */

body {
    margin: 0;
}

/* ==========================================================================
   Links
   ========================================================================== */

/**
 * Address `outline` inconsistency between Chrome and other browsers.
 */

a:focus {
    outline: thin dotted;
}

/**
 * Improve readability when focused and also mouse hovered in all browsers.
 */

a:active,
a:hover {
    outline: 0;
}

/* ==========================================================================
   Typography
   ========================================================================== */

/**
 * Address font sizes and margins set differently in IE 6/7.
 * Address font sizes within `section` and `article` in Firefox 4+, Safari 5,
 * and Chrome.
 */

h1 {
    font-size: 2em;
    margin: 0.67em 0;
}

h2 {
    font-size: 1.5em;
    margin: 0.83em 0;
}

h3 {
    font-size: 1.17em;
    margin: 1em 0;
}

h4 {
    font-size: 1em;
    margin: 1.33em 0;
}

h5 {
    font-size: 0.83em;
    margin: 1.67em 0;
}

h6 {
    font-size: 0.67em;
    margin: 2.33em 0;
}

/**
 * Address styling not present in IE 7/8/9, Safari 5, and Chrome.
 */

abbr[title] {
    border-bottom: 1px dotted;
}

/**
 * Address style set to `bolder` in Firefox 3+, Safari 4/5, and Chrome.
 */

b,
strong {
    font-weight: bold;
}

blockquote {
    margin: 1em 40px;
}

/**
 * Address styling not present in Safari 5 and Chrome.
 */

dfn {
    font-style: italic;
}

/**
 * Address differences between Firefox and other browsers.
 * Known issue: no IE 6/7 normalization.
 */

hr {
    -moz-box-sizing: content-box;
    box-sizing: content-box;
    height: 0;
}

/**
 * Address styling not present in IE 6/7/8/9.
 */

mark {
    background: #ff0;
    color: #000;
}

/**
 * Address margins set differently in IE 6/7.
 */

p,
pre {
    margin: 1em 0;
}

/**
 * Correct font family set oddly in IE 6, Safari 4/5, and Chrome.
 */

code,
kbd,
pre,
samp {
    font-family: monospace, serif;
    _font-family: 'courier new', monospace;
    font-size: 1em;
}

/**
 * Improve readability of pre-formatted text in all browsers.
 */

pre {
    white-space: pre;
    white-space: pre-wrap;
    word-wrap: break-word;
}

/**
 * Address CSS quotes not supported in IE 6/7.
 */

q {
    quotes: none;
}

/**
 * Address `quotes` property not supported in Safari 4.
 */

q:before,
q:after {
    content: '';
    content: none;
}

/**
 * Address inconsistent and variable font size in all browsers.
 */

small {
    font-size: 80%;
}

/**
 * Prevent `sub` and `sup` affecting `line-height` in all browsers.
 */

sub,
sup {
    font-size: 75%;
    line-height: 0;
    position: relative;
    vertical-align: baseline;
}

sup {
    top: -0.5em;
}

sub {
    bottom: -0.25em;
}

/* ==========================================================================
   Lists
   ========================================================================== */

/**
 * Address margins set differently in IE 6/7.
 */

dl,
menu,
ol,
ul {
    margin: 1em 0;
}

dd {
    margin: 0 0 0 40px;
}

/**
 * Address paddings set differently in IE 6/7.
 */

menu,
ol,
ul {
    padding: 0 0 0 40px;
}

/**
 * Correct list images handled incorrectly in IE 7.
 */

nav ul,
nav ol {
    list-style: none;
    list-style-image: none;
}

/* ==========================================================================
   Embedded content
   ========================================================================== */

/**
 * 1. Remove border when inside `a` element in IE 6/7/8/9 and Firefox 3.
 * 2. Improve image quality when scaled in IE 7.
 */

img {
    border: 0; /* 1 */
    -ms-interpolation-mode: bicubic; /* 2 */
}

/**
 * Correct overflow displayed oddly in IE 9.
 */

svg:not(:root) {
    overflow: hidden;
}

/* ==========================================================================
   Figures
   ========================================================================== */

/**
 * Address margin not present in IE 6/7/8/9, Safari 5, and Opera 11.
 */

figure {
    margin: 0;
}

/* ==========================================================================
   Forms
   ========================================================================== */

/**
 * Correct margin displayed oddly in IE 6/7.
 */

form {
    margin: 0;
}

/**
 * Define consistent border, margin, and padding.
 */

fieldset {
    border: 1px solid #c0c0c0;
    margin: 0 2px;
    padding: 0.35em 0.625em 0.75em;
}

/**
 * 1. Correct color not being inherited in IE 6/7/8/9.
 * 2. Correct text not wrapping in Firefox 3.
 * 3. Correct alignment displayed oddly in IE 6/7.
 */

legend {
    border: 0; /* 1 */
    padding: 0;
    white-space: normal; /* 2 */
    *margin-left: -7px; /* 3 */
}

/**
 * 1. Correct font size not being inherited in all browsers.
 * 2. Address margins set differently in IE 6/7, Firefox 3+, Safari 5,
 *    and Chrome.
 * 3. Improve appearance and consistency in all browsers.
 */

button,
input,
select,
textarea {
    font-size: 100%; /* 1 */
    margin: 0; /* 2 */
    vertical-align: baseline; /* 3 */
    *vertical-align: middle; /* 3 */
}

/**
 * Address Firefox 3+ setting `line-height` on `input` using `!important` in
 * the UA stylesheet.
 */

button,
input {
    line-height: normal;
}

/**
 * Address inconsistent `text-transform` inheritance for `button` and `select`.
 * All other form control elements do not inherit `text-transform` values.
 * Correct `button` style inheritance in Chrome, Safari 5+, and IE 6+.
 * Correct `select` style inheritance in Firefox 4+ and Opera.
 */

button,
select {
    text-transform: none;
}

/**
 * 1. Avoid the WebKit bug in Android 4.0.* where (2) destroys native `audio`
 *    and `video` controls.
 * 2. Correct inability to style clickable `input` types in iOS.
 * 3. Improve usability and consistency of cursor style between image-type
 *    `input` and others.
 * 4. Remove inner spacing in IE 7 without affecting normal text inputs.
 *    Known issue: inner spacing remains in IE 6.
 */

button,
html input[type="button"], /* 1 */
input[type="reset"],
input[type="submit"] {
    -webkit-appearance: button; /* 2 */
    cursor: pointer; /* 3 */
    *overflow: visible;  /* 4 */
}

/**
 * Re-set default cursor for disabled elements.
 */

button[disabled],
html input[disabled] {
    cursor: default;
}

/**
 * 1. Address box sizing set to content-box in IE 8/9.
 * 2. Remove excess padding in IE 8/9.
 * 3. Remove excess padding in IE 7.
 *    Known issue: excess padding remains in IE 6.
 */

input[type="checkbox"],
input[type="radio"] {
    box-sizing: border-box; /* 1 */
    padding: 0; /* 2 */
    *height: 13px; /* 3 */
    *width: 13px; /* 3 */
}

/**
 * 1. Address `appearance` set to `searchfield` in Safari 5 and Chrome.
 * 2. Address `box-sizing` set to `border-box` in Safari 5 and Chrome
 *    (include `-moz` to future-proof).
 */

input[type="search"] {
    -webkit-appearance: textfield; /* 1 */
    -moz-box-sizing: content-box;
    -webkit-box-sizing: content-box; /* 2 */
    box-sizing: content-box;
}

/**
 * Remove inner padding and search cancel button in Safari 5 and Chrome
 * on OS X.
 */

input[type="search"]::-webkit-search-cancel-button,
input[type="search"]::-webkit-search-decoration {
    -webkit-appearance: none;
}

/**
 * Remove inner padding and border in Firefox 3+.
 */

button::-moz-focus-inner,
input::-moz-focus-inner {
    border: 0;
    padding: 0;
}

/**
 * 1. Remove default vertical scrollbar in IE 6/7/8/9.
 * 2. Improve readability and alignment in all browsers.
 */

textarea {
    overflow: auto; /* 1 */
    vertical-align: top; /* 2 */
}

/* ==========================================================================
   Tables
   ========================================================================== */

/**
 * Remove most spacing between table cells.
 */

table {
    border-collapse: collapse;
    border-spacing: 0;
}

  </style>

  <style type="text/css">
  
  html, body {
    margin: 0;
    padding: 0;
    min-height: 100%;
  }
  body {
    background: #fff;
    font-family: "Source Sans Pro", "Helvetica Neueue", Helvetica, sans;
    font-weight: 300;
    font-size: 16px;
    line-height: 1.6em;
  }
  #content {
    width: 70%;
    max-width: 850px;
    float: left;
    padding: 30px 60px;
    border-left: 1px solid #ddd;
  }
  #sidebar {
    width: 25%;
    float: left;
    padding: 30px;
    overflow: hidden;
  }
  #nav {
    font-size: 130%;
    margin: 0 0 15px 0;
  }

  #top {
    display: block;
    position: fixed;
    bottom: 5px;
    left: 5px;
    font-size: .85em;
    text-transform: uppercase;
  }

  #footer {
    font-size: .75em;
    padding: 5px 30px;
    border-top: 1px solid #ddd;
    text-align: right;
  }
    #footer p {
      margin: 0 0 0 30px;
      display: inline-block;
    }

  h1, h2, h3, h4, h5 {
    font-weight: 300;
  }
  h1 {
    font-size: 2.5em;
    line-height: 1.1em;
    margin: 0 0 .50em 0;
  }

  h2 {
    font-size: 1.75em;
    margin: 1em 0 .50em 0;
  }

  h3 {
    margin: 25px 0 10px 0;
  }

  h4 {
    margin: 0;
    font-size: 105%;
  }

  a {
    color: #058;
    text-decoration: none;
    transition: color .3s ease-in-out;
  }

  a:hover {
    color: #e08524;
    transition: color .3s ease-in-out;
  }

  pre, code, .mono, .name {
    font-family: "Ubuntu Mono", "Cousine", "DejaVu Sans Mono", monospace;
  }

  .title .name {
    font-weight: bold;
  }
  .section-title {
    margin-top: 2em;
  }
  .ident {
    color: #900;
  }

  code {
    background: #f9f9f9;
  } 

  pre {
    background: #fefefe;
    border: 1px solid #ddd;
    box-shadow: 2px 2px 0 #f3f3f3;
    margin: 0 30px;
    padding: 15px 30px;
  }

  .codehilite {
    margin: 0 30px 10px 30px;
  }

    .codehilite pre {
      margin: 0;
    }
    .codehilite .err { background: #ff3300; color: #fff !important; } 

  table#module-list {
    font-size: 110%;
  }

    table#module-list tr td:first-child {
      padding-right: 10px;
      white-space: nowrap;
    }

    table#module-list td {
      vertical-align: top;
      padding-bottom: 8px;
    }

      table#module-list td p {
        margin: 0 0 7px 0;
      }

  .def {
    display: table;
  }

    .def p {
      display: table-cell;
      vertical-align: top;
      text-align: left;
    }

    .def p:first-child {
      white-space: nowrap;
    }

    .def p:last-child {
      width: 100%;
    }


  #index {
    list-style-type: none;
    margin: 0;
    padding: 0;
  }
    ul#index .class_name {
      /* font-size: 110%; */
      font-weight: bold;
    }
    #index ul {
      margin: 0;
    }

  .item {
    margin: 0 0 15px 0;
  }

    .item .class {
      margin: 0 0 25px 30px;
    }

      .item .class ul.class_list {
        margin: 0 0 20px 0;
      }

    .item .name {
      background: #fafafa;
      margin: 0;
      font-weight: bold;
      padding: 5px 10px;
      border-radius: 3px;
      display: inline-block;
      min-width: 40%;
    }
      .item .name:hover {
        background: #f6f6f6;
      }

    .item .empty_desc {
      margin: 0 0 5px 0;
      padding: 0;
    }

    .item .inheritance {
      margin: 3px 0 0 30px;
    }

    .item .inherited {
      color: #666;
    }

    .item .desc {
      padding: 0 8px;
      margin: 0;
    }

      .item .desc p {
        margin: 0 0 10px 0;
      }

    .source_cont {
      margin: 0;
      padding: 0;
    }

    .source_link a {
      background: #ffc300;
      font-weight: 400;
      font-size: .75em;
      text-transform: uppercase;
      color: #fff;
      text-shadow: 1px 1px 0 #f4b700;
      
      padding: 3px 8px;
      border-radius: 2px;
      transition: background .3s ease-in-out;
    }
      .source_link a:hover {
        background: #FF7200;
        text-shadow: none;
        transition: background .3s ease-in-out;
      }

    .source {
      display: none;
      max-height: 600px;
      overflow-y: scroll;
      margin-bottom: 15px;
    }

      .source .codehilite {
        margin: 0;
      }

  .desc h1, .desc h2, .desc h3 {
    font-size: 100% !important;
  }
  .clear {
    clear: both;
  }

  @media all and (max-width: 950px) {
    #sidebar {
      width: 35%;
    }
    #content {
      width: 65%;
    }
  }
  @media all and (max-width: 650px) {
    #top {
      display: none;
    }
    #sidebar {
      float: none;
      width: auto;
    }
    #content {
      float: none;
      width: auto;
      padding: 30px;
    }

    #index ul {
      padding: 0;
      margin-bottom: 15px;
    }
    #index ul li {
      display: inline-block;
      margin-right: 30px;
    }
    #footer {
      text-align: left;
    }
    #footer p {
      display: block;
      margin: inherit;
    }
  }

  /*****************************/

  </style>

  <style type="text/css">
  .codehilite .hll { background-color: #ffffcc }
.codehilite  { background: #f8f8f8; }
.codehilite .c { color: #408080; font-style: italic } /* Comment */
.codehilite .err { border: 1px solid #FF0000 } /* Error */
.codehilite .k { color: #008000; font-weight: bold } /* Keyword */
.codehilite .o { color: #666666 } /* Operator */
.codehilite .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
.codehilite .cm { color: #408080; font-style: italic } /* Comment.Multiline */
.codehilite .cp { color: #BC7A00 } /* Comment.Preproc */
.codehilite .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
.codehilite .c1 { color: #408080; font-style: italic } /* Comment.Single */
.codehilite .cs { color: #408080; font-style: italic } /* Comment.Special */
.codehilite .gd { color: #A00000 } /* Generic.Deleted */
.codehilite .ge { font-style: italic } /* Generic.Emph */
.codehilite .gr { color: #FF0000 } /* Generic.Error */
.codehilite .gh { color: #000080; font-weight: bold } /* Generic.Heading */
.codehilite .gi { color: #00A000 } /* Generic.Inserted */
.codehilite .go { color: #888888 } /* Generic.Output */
.codehilite .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
.codehilite .gs { font-weight: bold } /* Generic.Strong */
.codehilite .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
.codehilite .gt { color: #0044DD } /* Generic.Traceback */
.codehilite .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
.codehilite .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
.codehilite .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
.codehilite .kp { color: #008000 } /* Keyword.Pseudo */
.codehilite .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
.codehilite .kt { color: #B00040 } /* Keyword.Type */
.codehilite .m { color: #666666 } /* Literal.Number */
.codehilite .s { color: #BA2121 } /* Literal.String */
.codehilite .na { color: #7D9029 } /* Name.Attribute */
.codehilite .nb { color: #008000 } /* Name.Builtin */
.codehilite .nc { color: #0000FF; font-weight: bold } /* Name.Class */
.codehilite .no { color: #880000 } /* Name.Constant */
.codehilite .nd { color: #AA22FF } /* Name.Decorator */
.codehilite .ni { color: #999999; font-weight: bold } /* Name.Entity */
.codehilite .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
.codehilite .nf { color: #0000FF } /* Name.Function */
.codehilite .nl { color: #A0A000 } /* Name.Label */
.codehilite .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
.codehilite .nt { color: #008000; font-weight: bold } /* Name.Tag */
.codehilite .nv { color: #19177C } /* Name.Variable */
.codehilite .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
.codehilite .w { color: #bbbbbb } /* Text.Whitespace */
.codehilite .mb { color: #666666 } /* Literal.Number.Bin */
.codehilite .mf { color: #666666 } /* Literal.Number.Float */
.codehilite .mh { color: #666666 } /* Literal.Number.Hex */
.codehilite .mi { color: #666666 } /* Literal.Number.Integer */
.codehilite .mo { color: #666666 } /* Literal.Number.Oct */
.codehilite .sb { color: #BA2121 } /* Literal.String.Backtick */
.codehilite .sc { color: #BA2121 } /* Literal.String.Char */
.codehilite .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
.codehilite .s2 { color: #BA2121 } /* Literal.String.Double */
.codehilite .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
.codehilite .sh { color: #BA2121 } /* Literal.String.Heredoc */
.codehilite .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
.codehilite .sx { color: #008000 } /* Literal.String.Other */
.codehilite .sr { color: #BB6688 } /* Literal.String.Regex */
.codehilite .s1 { color: #BA2121 } /* Literal.String.Single */
.codehilite .ss { color: #19177C } /* Literal.String.Symbol */
.codehilite .bp { color: #008000 } /* Name.Builtin.Pseudo */
.codehilite .vc { color: #19177C } /* Name.Variable.Class */
.codehilite .vg { color: #19177C } /* Name.Variable.Global */
.codehilite .vi { color: #19177C } /* Name.Variable.Instance */
.codehilite .il { color: #666666 } /* Literal.Number.Integer.Long */
  </style>

  <style type="text/css">
  
/* ==========================================================================
   EXAMPLE Media Queries for Responsive Design.
   These examples override the primary ('mobile first') styles.
   Modify as content requires.
   ========================================================================== */

@media only screen and (min-width: 35em) {
    /* Style adjustments for viewports that meet the condition */
}

@media print,
       (-o-min-device-pixel-ratio: 5/4),
       (-webkit-min-device-pixel-ratio: 1.25),
       (min-resolution: 120dpi) {
    /* Style adjustments for high resolution devices */
}

/* ==========================================================================
   Print styles.
   Inlined to avoid required HTTP connection: h5bp.com/r
   ========================================================================== */

@media print {
    * {
        background: transparent !important;
        color: #000 !important; /* Black prints faster: h5bp.com/s */
        box-shadow: none !important;
        text-shadow: none !important;
    }

    a,
    a:visited {
        text-decoration: underline;
    }

    a[href]:after {
        content: " (" attr(href) ")";
    }

    abbr[title]:after {
        content: " (" attr(title) ")";
    }

    /*
     * Don't show links for images, or javascript/internal links
     */

    .ir a:after,
    a[href^="javascript:"]:after,
    a[href^="#"]:after {
        content: "";
    }

    pre,
    blockquote {
        border: 1px solid #999;
        page-break-inside: avoid;
    }

    thead {
        display: table-header-group; /* h5bp.com/t */
    }

    tr,
    img {
        page-break-inside: avoid;
    }

    img {
        max-width: 100% !important;
    }

    @page {
        margin: 0.5cm;
    }

    p,
    h2,
    h3 {
        orphans: 3;
        widows: 3;
    }

    h2,
    h3 {
        page-break-after: avoid;
    }
}

  </style>

  <script type="text/javascript">
  function toggle(id, $link) {
    $node = document.getElementById(id);
    if (!$node)
    return;
    if (!$node.style.display || $node.style.display == 'none') {
    $node.style.display = 'block';
    $link.innerHTML = 'Hide source &nequiv;';
    } else {
    $node.style.display = 'none';
    $link.innerHTML = 'Show source &equiv;';
    }
  }
  </script>
</head>
<body>
<a href="#" id="top">Top</a>

<div id="container">
    
  
  <div id="sidebar">
    <h1>Index</h1>
    <ul id="index">
    <li class="set"><h3><a href="#header-variables">Module variables</a></h3>
      
  <ul>
    <li class="mono"><a href="#heronpy.api.cloudpickle.DELETE_GLOBAL">DELETE_GLOBAL</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.EXTENDED_ARG">EXTENDED_ARG</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.GLOBAL_OPS">GLOBAL_OPS</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.HAVE_ARGUMENT">HAVE_ARGUMENT</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.LOAD_GLOBAL">LOAD_GLOBAL</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.PY3">PY3</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.STORE_GLOBAL">STORE_GLOBAL</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.k1">k1</a></li>
  </ul>

    </li>

    <li class="set"><h3><a href="#header-functions">Functions</a></h3>
      
  <ul>
    <li class="mono"><a href="#heronpy.api.cloudpickle.dump">dump</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.dumps">dumps</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.islambda">islambda</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.print_exec">print_exec</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.subimport">subimport</a></li>
  </ul>

    </li>

    <li class="set"><h3><a href="#header-classes">Classes</a></h3>
      <ul>
        <li class="mono">
        <span class="class_name"><a href="#heronpy.api.cloudpickle.CloudPickler">CloudPickler</a></span>
        
          
  <ul>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.__init__">__init__</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.clear_memo">clear_memo</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.dump">dump</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.extract_code_globals">extract_code_globals</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.extract_func_data">extract_func_data</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.get">get</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.inject_addons">inject_addons</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.inject_numpy">inject_numpy</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.memoize">memoize</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.persistent_id">persistent_id</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.put">put</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save">save</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_attrgetter">save_attrgetter</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_bool">save_bool</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_buffer">save_buffer</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_builtin_function">save_builtin_function</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_codeobject">save_codeobject</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_dict">save_dict</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_empty_tuple">save_empty_tuple</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_file">save_file</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_float">save_float</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_function">save_function</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_function_tuple">save_function_tuple</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_global">save_global</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_inst">save_inst</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_instancemethod">save_instancemethod</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_int">save_int</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_itemgetter">save_itemgetter</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_list">save_list</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_long">save_long</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_memoryview">save_memoryview</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_module">save_module</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_none">save_none</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_partial">save_partial</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_pers">save_pers</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_property">save_property</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_reduce">save_reduce</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_string">save_string</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_tuple">save_tuple</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_ufunc">save_ufunc</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_unicode">save_unicode</a></li>
    <li class="mono"><a href="#heronpy.api.cloudpickle.CloudPickler.save_unsupported">save_unsupported</a></li>
  </ul>

        </li>
      </ul>
    </li>

    </ul>
  </div>

    <article id="content">
      
  

  


  <header id="section-intro">
  <h1 class="title"><span class="name">heronpy.api.cloudpickle</span> module</h1>
  <p>This class is defined to override standard pickle functionality
The goals of it follow:
-Serialize lambdas and nested functions to compiled byte code
-Deal with main module correctly
-Deal with other non-serializable objects
It does not include an unpickler, as standard python unpickling suffices.
This module was extracted from the <code>cloud</code> package, developed by <code>PiCloud, Inc.
&lt;http://www.picloud.com&gt;</code><em>.
Copyright (c) 2012, Regents of the University of California.
Copyright (c) 2009 <code>PiCloud, Inc. &lt;http://www.picloud.com&gt;</code></em>.
All rights reserved.
Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions
are met:
  * Redistributions of source code must retain the above copyright
    notice, this list of conditions and the following disclaimer.
  * Redistributions in binary form must reproduce the above copyright
    notice, this list of conditions and the following disclaimer in the
    documentation and/or other materials provided with the distribution.
  * Neither the name of the University of California, Berkeley nor the
    names of its contributors may be used to endorse or promote
    products derived from this software without specific prior written
    permission.
THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
"AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>
  
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle" class="source">
    <div class="codehilite"><pre><span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This class is defined to override standard pickle functionality</span>
<span class="sd">The goals of it follow:</span>
<span class="sd">-Serialize lambdas and nested functions to compiled byte code</span>
<span class="sd">-Deal with main module correctly</span>
<span class="sd">-Deal with other non-serializable objects</span>
<span class="sd">It does not include an unpickler, as standard python unpickling suffices.</span>
<span class="sd">This module was extracted from the `cloud` package, developed by `PiCloud, Inc.</span>
<span class="sd">&lt;http://www.picloud.com&gt;`_.</span>
<span class="sd">Copyright (c) 2012, Regents of the University of California.</span>
<span class="sd">Copyright (c) 2009 `PiCloud, Inc. &lt;http://www.picloud.com&gt;`_.</span>
<span class="sd">All rights reserved.</span>
<span class="sd">Redistribution and use in source and binary forms, with or without</span>
<span class="sd">modification, are permitted provided that the following conditions</span>
<span class="sd">are met:</span>
<span class="sd">  * Redistributions of source code must retain the above copyright</span>
<span class="sd">    notice, this list of conditions and the following disclaimer.</span>
<span class="sd">  * Redistributions in binary form must reproduce the above copyright</span>
<span class="sd">    notice, this list of conditions and the following disclaimer in the</span>
<span class="sd">    documentation and/or other materials provided with the distribution.</span>
<span class="sd">  * Neither the name of the University of California, Berkeley nor the</span>
<span class="sd">    names of its contributors may be used to endorse or promote</span>
<span class="sd">    products derived from this software without specific prior written</span>
<span class="sd">    permission.</span>
<span class="sd">THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="sd">&quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="sd">LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
<span class="sd">A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<span class="sd">HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<span class="sd">SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED</span>
<span class="sd">TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR</span>
<span class="sd">PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF</span>
<span class="sd">LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING</span>
<span class="sd">NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS</span>
<span class="sd">SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">opcode</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">dis</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">weakref</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version</span> <span class="o">&lt;</span> <span class="s1">&#39;3&#39;</span><span class="p">:</span>
  <span class="kn">from</span> <span class="nn">pickle</span> <span class="kn">import</span> <span class="n">Pickler</span> <span class="c1"># pylint: disable=ungrouped-imports</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">cStringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
  <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">StringIO</span> <span class="kn">import</span> <span class="n">StringIO</span>
  <span class="n">PY3</span> <span class="o">=</span> <span class="bp">False</span>
<span class="k">else</span><span class="p">:</span>
  <span class="n">types</span><span class="o">.</span><span class="n">ClassType</span> <span class="o">=</span> <span class="nb">type</span>
  <span class="kn">from</span> <span class="nn">pickle</span> <span class="kn">import</span> <span class="n">_Pickler</span> <span class="k">as</span> <span class="n">Pickler</span> <span class="c1"># pylint: disable=ungrouped-imports</span>
  <span class="kn">from</span> <span class="nn">io</span> <span class="kn">import</span> <span class="n">BytesIO</span> <span class="k">as</span> <span class="n">StringIO</span> <span class="c1"># pylint: disable=ungrouped-imports</span>
  <span class="n">PY3</span> <span class="o">=</span> <span class="bp">True</span>

<span class="c1">#relevant opcodes</span>
<span class="n">STORE_GLOBAL</span> <span class="o">=</span> <span class="n">opcode</span><span class="o">.</span><span class="n">opmap</span><span class="p">[</span><span class="s1">&#39;STORE_GLOBAL&#39;</span><span class="p">]</span>
<span class="n">DELETE_GLOBAL</span> <span class="o">=</span> <span class="n">opcode</span><span class="o">.</span><span class="n">opmap</span><span class="p">[</span><span class="s1">&#39;DELETE_GLOBAL&#39;</span><span class="p">]</span>
<span class="n">LOAD_GLOBAL</span> <span class="o">=</span> <span class="n">opcode</span><span class="o">.</span><span class="n">opmap</span><span class="p">[</span><span class="s1">&#39;LOAD_GLOBAL&#39;</span><span class="p">]</span>
<span class="n">GLOBAL_OPS</span> <span class="o">=</span> <span class="p">(</span><span class="n">STORE_GLOBAL</span><span class="p">,</span> <span class="n">DELETE_GLOBAL</span><span class="p">,</span> <span class="n">LOAD_GLOBAL</span><span class="p">)</span>
<span class="n">HAVE_ARGUMENT</span> <span class="o">=</span> <span class="n">dis</span><span class="o">.</span><span class="n">HAVE_ARGUMENT</span>
<span class="n">EXTENDED_ARG</span> <span class="o">=</span> <span class="n">dis</span><span class="o">.</span><span class="n">EXTENDED_ARG</span>


<span class="k">def</span> <span class="nf">islambda</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
  <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39;__name__&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&lt;lambda&gt;&#39;</span>


<span class="n">_BUILTIN_TYPE_NAMES</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">k1</span><span class="p">,</span> <span class="n">v1</span> <span class="ow">in</span> <span class="n">types</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
  <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">:</span> <span class="c1"># pylint: disable=unidiomatic-typecheck</span>
    <span class="n">_BUILTIN_TYPE_NAMES</span><span class="p">[</span><span class="n">v1</span><span class="p">]</span> <span class="o">=</span> <span class="n">k1</span>


<span class="k">def</span> <span class="nf">_builtin_type</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
  <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">types</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>


<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">_walk_global_ops</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yield (opcode, argument number) tuples for all</span>
<span class="sd">    global-referencing instructions in *code*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">code</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="s1">&#39;co_code&#39;</span><span class="p">,</span> <span class="n">b</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">PY3</span><span class="p">:</span>
      <span class="n">code</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="nb">ord</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>

    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">extended_arg</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">:</span>
      <span class="n">op</span> <span class="o">=</span> <span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
      <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="k">if</span> <span class="n">op</span> <span class="o">&gt;=</span> <span class="n">HAVE_ARGUMENT</span><span class="p">:</span>
        <span class="n">oparg</span> <span class="o">=</span> <span class="n">code</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">code</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">extended_arg</span>
        <span class="n">extended_arg</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span>
        <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="n">EXTENDED_ARG</span><span class="p">:</span>
          <span class="n">extended_arg</span> <span class="o">=</span> <span class="n">oparg</span> <span class="o">*</span> <span class="mi">65536</span>
        <span class="k">if</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">GLOBAL_OPS</span><span class="p">:</span>
          <span class="k">yield</span> <span class="n">op</span><span class="p">,</span> <span class="n">oparg</span>

<span class="k">else</span><span class="p">:</span>
  <span class="k">def</span> <span class="nf">_walk_global_ops</span><span class="p">(</span><span class="n">code</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yield (opcode, argument number) tuples for all</span>
<span class="sd">    global-referencing instructions in *code*.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">instr</span> <span class="ow">in</span> <span class="n">dis</span><span class="o">.</span><span class="n">get_instructions</span><span class="p">(</span><span class="n">code</span><span class="p">):</span> <span class="c1"># pylint: disable=no-member</span>
      <span class="n">op</span> <span class="o">=</span> <span class="n">instr</span><span class="o">.</span><span class="n">opcode</span>
      <span class="k">if</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">GLOBAL_OPS</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">op</span><span class="p">,</span> <span class="n">instr</span><span class="o">.</span><span class="n">arg</span>


<span class="k">class</span> <span class="nc">CloudPickler</span><span class="p">(</span><span class="n">Pickler</span><span class="p">):</span> <span class="c1"># pylint: disable=too-many-public-methods</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  CloudPickler class</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">dispatch</span> <span class="o">=</span> <span class="n">Pickler</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filen</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">Pickler</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filen</span><span class="p">,</span> <span class="n">protocol</span><span class="p">)</span>
    <span class="c1"># set of modules to unpickle</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">modules</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="c1"># map ids to dictionary. used to ensure that functions can share global env</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">globals_ref</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">inject_addons</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">Pickler</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="k">if</span> <span class="s1">&#39;recursion&#39;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Could not pickle object as excessively deep recursion required.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PickleError</span><span class="p">:</span>
      <span class="k">raise</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">print_exec</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
      <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">save_memoryview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fallback to save_string&quot;&quot;&quot;</span>
    <span class="n">Pickler</span><span class="o">.</span><span class="n">save_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">save_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fallback to save_string&quot;&quot;&quot;</span>
    <span class="n">Pickler</span><span class="o">.</span><span class="n">save_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
  <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
    <span class="n">dispatch</span><span class="p">[</span><span class="n">memoryview</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_memoryview</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">dispatch</span><span class="p">[</span><span class="nb">buffer</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_buffer</span>

  <span class="k">def</span> <span class="nf">save_unsupported</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span> <span class="c1"># pylint: disable=no-self-use</span>
    <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Cannot pickle objects of type </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
  <span class="n">dispatch</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">GeneratorType</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_unsupported</span>

  <span class="c1"># itertools objects do not pickle!</span>
  <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">:</span> <span class="c1"># pylint: disable=unidiomatic-typecheck</span>
      <span class="n">dispatch</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_unsupported</span>

  <span class="k">def</span> <span class="nf">save_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save a module as an import</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">subimport</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__name__</span><span class="p">,),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
  <span class="n">dispatch</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_module</span>

  <span class="k">def</span> <span class="nf">save_codeobject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save a code object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
      <span class="n">args</span> <span class="o">=</span> <span class="p">(</span>
          <span class="n">obj</span><span class="o">.</span><span class="n">co_argcount</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_kwonlyargcount</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_nlocals</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_stacksize</span><span class="p">,</span>
          <span class="n">obj</span><span class="o">.</span><span class="n">co_flags</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_code</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_consts</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_names</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">,</span>
          <span class="n">obj</span><span class="o">.</span><span class="n">co_filename</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_firstlineno</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_lnotab</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_freevars</span><span class="p">,</span>
          <span class="n">obj</span><span class="o">.</span><span class="n">co_cellvars</span>
      <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">args</span> <span class="o">=</span> <span class="p">(</span>
          <span class="n">obj</span><span class="o">.</span><span class="n">co_argcount</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_nlocals</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_stacksize</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_flags</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_code</span><span class="p">,</span>
          <span class="n">obj</span><span class="o">.</span><span class="n">co_consts</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_names</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_filename</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span>
          <span class="n">obj</span><span class="o">.</span><span class="n">co_firstlineno</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_lnotab</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_freevars</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_cellvars</span>
      <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">CodeType</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
  <span class="n">dispatch</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">CodeType</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_codeobject</span>

  <span class="k">def</span> <span class="nf">save_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Registered with the dispatch to handle all function types.</span>
<span class="sd">    Determines what kind of function obj is (e.g. lambda, defined at</span>
<span class="sd">    interactive prompt, etc) and handles the pickling appropriately.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">write</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__name__</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="c1"># whichmodule() could fail, see</span>
      <span class="c1"># https://bitbucket.org/gutworth/six/issues/63/importing-six-breaks-pickling</span>
      <span class="n">modname</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">whichmodule</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
      <span class="n">modname</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># print(&#39;which gives %s %s %s&#39; % (modname, obj, name))</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">themodule</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">modname</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
      <span class="c1"># eval&#39;d items such as namedtuple give invalid items for their function __module__</span>
      <span class="n">modname</span> <span class="o">=</span> <span class="s1">&#39;__main__&#39;</span>

    <span class="k">if</span> <span class="n">modname</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
      <span class="n">themodule</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">themodule</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">themodule</span><span class="p">)</span>
      <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">themodule</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="n">obj</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_global</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="c1"># if func is lambda, def&#39;ed at prompt, is in main, or is nested, then</span>
    <span class="c1"># we&#39;ll pickle the actual function object rather than simply saving a</span>
    <span class="c1"># reference (as is done in default pickler), via save_function_tuple.</span>
    <span class="k">if</span> <span class="n">islambda</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">__code__</span><span class="o">.</span><span class="n">co_filename</span> <span class="o">==</span> <span class="s1">&#39;&lt;stdin&gt;&#39;</span> <span class="ow">or</span> <span class="n">themodule</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="c1">#print(&quot;save global&quot;, islambda(obj), obj.__code__.co_filename, modname, themodule)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">save_function_tuple</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
      <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># func is nested</span>
      <span class="n">klass</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">themodule</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">klass</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">klass</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_function_tuple</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
      <span class="c1"># essentially save_reduce, but workaround needed to avoid recursion</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">_restore_attr</span><span class="p">)</span>
      <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">MARK</span> <span class="o">+</span> <span class="n">pickle</span><span class="o">.</span><span class="n">GLOBAL</span> <span class="o">+</span> <span class="n">modname</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">memoize</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
      <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">TUPLE</span> <span class="o">+</span> <span class="n">pickle</span><span class="o">.</span><span class="n">REDUCE</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">GLOBAL</span> <span class="o">+</span> <span class="n">modname</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">memoize</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
  <span class="n">dispatch</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_function</span>

  <span class="k">def</span> <span class="nf">save_function_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;  Pickles an actual func object.</span>
<span class="sd">    A func comprises: code, globals, defaults, closure, and dict.  We</span>
<span class="sd">    extract and save these, injecting reducing functions at certain points</span>
<span class="sd">    to recreate the func object.  Keep in mind that some of these pieces</span>
<span class="sd">    can contain a ref to the func itself.  Thus, a naive save on these</span>
<span class="sd">    pieces could trigger an infinite loop of save&#39;s.  To get around that,</span>
<span class="sd">    we first create a skeleton func object using just the code (this is</span>
<span class="sd">    safe, since this won&#39;t contain a ref to the func), and memoize it as</span>
<span class="sd">    soon as it&#39;s created.  The other stuff can then be filled in later.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span>
    <span class="n">write</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span>

    <span class="n">code</span><span class="p">,</span> <span class="n">f_globals</span><span class="p">,</span> <span class="n">defaults</span><span class="p">,</span> <span class="n">closure</span><span class="p">,</span> <span class="n">dct</span><span class="p">,</span> <span class="n">base_globals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_func_data</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

    <span class="n">save</span><span class="p">(</span><span class="n">_fill_function</span><span class="p">)</span>  <span class="c1"># skeleton function updater</span>
    <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">MARK</span><span class="p">)</span>    <span class="c1"># beginning of tuple that _fill_function expects</span>

    <span class="c1"># create a skeleton function object and memoize it</span>
    <span class="n">save</span><span class="p">(</span><span class="n">_make_skel_func</span><span class="p">)</span>
    <span class="n">save</span><span class="p">((</span><span class="n">code</span><span class="p">,</span> <span class="n">closure</span><span class="p">,</span> <span class="n">base_globals</span><span class="p">))</span>
    <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">REDUCE</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">memoize</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

    <span class="c1"># save the rest of the func data needed by _fill_function</span>
    <span class="n">save</span><span class="p">(</span><span class="n">f_globals</span><span class="p">)</span>
    <span class="n">save</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span>
    <span class="n">save</span><span class="p">(</span><span class="n">dct</span><span class="p">)</span>
    <span class="n">save</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">__module__</span><span class="p">)</span>
    <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">TUPLE</span><span class="p">)</span>
    <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">REDUCE</span><span class="p">)</span>  <span class="c1"># applies _fill_function on the tuple</span>

  <span class="n">_extract_code_globals_cache</span> <span class="o">=</span> <span class="p">(</span>
      <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s2">&quot;pypy_version_info&quot;</span><span class="p">)</span>
      <span class="k">else</span> <span class="p">{}</span>
  <span class="p">)</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">extract_code_globals</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">co</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find all globals names read or written to by codeblock co</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out_names</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_extract_code_globals_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">co</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">out_names</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">co</span><span class="o">.</span><span class="n">co_names</span>
      <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="c1"># PyPy &quot;builtin-code&quot; object</span>
        <span class="n">out_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">out_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">oparg</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">oparg</span> <span class="ow">in</span> <span class="n">_walk_global_ops</span><span class="p">(</span><span class="n">co</span><span class="p">))</span>

        <span class="c1"># see if nested function have any global refs</span>
        <span class="k">if</span> <span class="n">co</span><span class="o">.</span><span class="n">co_consts</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">const</span> <span class="ow">in</span> <span class="n">co</span><span class="o">.</span><span class="n">co_consts</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">const</span><span class="p">)</span> <span class="ow">is</span> <span class="n">types</span><span class="o">.</span><span class="n">CodeType</span><span class="p">:</span> <span class="c1"># pylint: disable=unidiomatic-typecheck</span>
              <span class="n">out_names</span> <span class="o">|=</span> <span class="n">cls</span><span class="o">.</span><span class="n">extract_code_globals</span><span class="p">(</span><span class="n">const</span><span class="p">)</span>

      <span class="n">cls</span><span class="o">.</span><span class="n">_extract_code_globals_cache</span><span class="p">[</span><span class="n">co</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_names</span>

    <span class="k">return</span> <span class="n">out_names</span>

  <span class="k">def</span> <span class="nf">extract_func_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Turn the function into a tuple of data necessary to recreate it:</span>
<span class="sd">      code, globals, defaults, closure, dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__code__</span>

    <span class="c1"># extract all global ref&#39;s</span>
    <span class="n">func_global_refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_code_globals</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

    <span class="c1"># process all variables referenced by global environment</span>
    <span class="n">f_globals</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">func_global_refs</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">func</span><span class="o">.</span><span class="n">__globals__</span><span class="p">:</span>
        <span class="n">f_globals</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__globals__</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>

    <span class="c1"># defaults requires no processing</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__defaults__</span>

    <span class="c1"># process closure</span>
    <span class="n">closure</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">cell_contents</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">func</span><span class="o">.</span><span class="n">__closure__</span><span class="p">]</span> <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="n">__closure__</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="c1"># save the dict</span>
    <span class="n">dct</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__dict__</span>

    <span class="n">base_globals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals_ref</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">__globals__</span><span class="p">),</span> <span class="p">{})</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">globals_ref</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">__globals__</span><span class="p">)]</span> <span class="o">=</span> <span class="n">base_globals</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">f_globals</span><span class="p">,</span> <span class="n">defaults</span><span class="p">,</span> <span class="n">closure</span><span class="p">,</span> <span class="n">dct</span><span class="p">,</span> <span class="n">base_globals</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">save_builtin_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">__module__</span> <span class="ow">is</span> <span class="s2">&quot;__builtin__&quot;</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_global</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_function</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
  <span class="n">dispatch</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">BuiltinFunctionType</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_builtin_function</span>

  <span class="k">def</span> <span class="nf">save_global</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pack</span><span class="o">=</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">):</span> <span class="c1"># pylint: disable=too-many-branches</span>
    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">__module__</span> <span class="o">==</span> <span class="s2">&quot;__builtin__&quot;</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">__module__</span> <span class="o">==</span> <span class="s2">&quot;builtins&quot;</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">_BUILTIN_TYPE_NAMES</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_builtin_type</span><span class="p">,</span> <span class="p">(</span><span class="n">_BUILTIN_TYPE_NAMES</span><span class="p">[</span><span class="n">obj</span><span class="p">],),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__name__</span>

    <span class="n">modname</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">modname</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="c1"># whichmodule() could fail, see</span>
        <span class="c1"># https://bitbucket.org/gutworth/six/issues/63/importing-six-breaks-pickling</span>
        <span class="n">modname</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">whichmodule</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">modname</span> <span class="o">=</span> <span class="s1">&#39;__main__&#39;</span>

    <span class="k">if</span> <span class="n">modname</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
      <span class="n">themodule</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="nb">__import__</span><span class="p">(</span><span class="n">modname</span><span class="p">)</span>
      <span class="n">themodule</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">modname</span><span class="p">]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">themodule</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">themodule</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">themodule</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="n">obj</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">Pickler</span><span class="o">.</span><span class="n">save_global</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="n">typ</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">obj</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ClassType</span><span class="p">)):</span>
      <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>  <span class="c1"># copy dict proxy to a dict</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;__dict__&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="nb">property</span><span class="p">):</span>
        <span class="c1"># don&#39;t extract dict that are properties</span>
        <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;__dict__&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
      <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;__weakref__&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

      <span class="c1"># hack as __new__ is stored differently in the __dict__</span>
      <span class="n">new_override</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;__new__&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">new_override</span><span class="p">:</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;__new__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__new__</span>

      <span class="c1"># workaround for namedtuple (hijacked by PySpark)</span>
      <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;_is_namedtuple_&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_load_namedtuple</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_fields</span><span class="p">))</span>
        <span class="k">return</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">_load_class</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">__bases__</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;__doc__&quot;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">__doc__</span><span class="p">}),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
      <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;__doc__&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
      <span class="c1"># handle property and staticmethod</span>
      <span class="n">dd</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">property</span><span class="p">):</span>
          <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;property&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
          <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">fget</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">fset</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">fdel</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">__doc__</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">staticmethod</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;__func__&#39;</span><span class="p">):</span>
          <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;staticmethod&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
          <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">__func__</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">classmethod</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;__func__&#39;</span><span class="p">):</span>
          <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;classmethod&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
          <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">__func__</span>
        <span class="n">dd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">TUPLE2</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">REDUCE</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t pickle </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>

  <span class="n">dispatch</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_global</span>
  <span class="n">dispatch</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">ClassType</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_global</span>

  <span class="k">def</span> <span class="nf">save_instancemethod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="c1"># Memoization rarely is ever useful due to python bounding</span>
    <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__func__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">__self__</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span>
          <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__func__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">__self__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">__self__</span><span class="o">.</span><span class="n">__class__</span><span class="p">),</span>
          <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
  <span class="n">dispatch</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_instancemethod</span>

  <span class="k">def</span> <span class="nf">save_inst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Inner logic to save instance. Based off pickle.save_inst</span>
<span class="sd">    Supports __transient__&quot;&quot;&quot;</span>
    <span class="n">cls</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__class__</span>

    <span class="n">memo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memo</span>
    <span class="n">write</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span>
    <span class="n">save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;__getinitargs__&#39;</span><span class="p">):</span>
      <span class="n">args</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__getinitargs__</span><span class="p">()</span>
      <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>  <span class="c1"># assert it&#39;s a sequence</span>
      <span class="n">pickle</span><span class="o">.</span><span class="n">_keep_alive</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="c1"># pylint: disable=protected-access</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">args</span> <span class="o">=</span> <span class="p">()</span>

    <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">MARK</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin</span><span class="p">:</span>
      <span class="n">save</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">save</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
      <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">OBJ</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">save</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
      <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">INST</span> <span class="o">+</span> <span class="n">cls</span><span class="o">.</span><span class="n">__module__</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">cls</span><span class="o">.</span><span class="n">__name__</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">memoize</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">getstate</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__getstate__</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="n">stuff</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span>
      <span class="c1">#remove items if transient</span>
      <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;__transient__&#39;</span><span class="p">):</span>
        <span class="n">transient</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__transient__</span>
        <span class="n">stuff</span> <span class="o">=</span> <span class="n">stuff</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">stuff</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
          <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">transient</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">stuff</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">stuff</span> <span class="o">=</span> <span class="n">getstate</span><span class="p">()</span>
      <span class="n">pickle</span><span class="o">.</span><span class="n">_keep_alive</span><span class="p">(</span><span class="n">stuff</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="c1"># pylint: disable=protected-access</span>
    <span class="n">save</span><span class="p">(</span><span class="n">stuff</span><span class="p">)</span>
    <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">BUILD</span><span class="p">)</span>

  <span class="k">if</span> <span class="ow">not</span> <span class="n">PY3</span><span class="p">:</span>
    <span class="n">dispatch</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">InstanceType</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_inst</span>

  <span class="k">def</span> <span class="nf">save_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="c1"># properties not correctly saved in python</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="nb">property</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">fget</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">fset</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">fdel</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">__doc__</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
  <span class="n">dispatch</span><span class="p">[</span><span class="nb">property</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_property</span>

  <span class="k">def</span> <span class="nf">save_itemgetter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;itemgetter serializer (needed for namedtuple support)&quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">Dummy</span><span class="p">:</span> <span class="c1"># pylint: disable=old-style-class</span>
      <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
      <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">item</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">obj</span><span class="p">(</span><span class="n">Dummy</span><span class="p">())</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
      <span class="n">items</span> <span class="o">=</span> <span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>

  <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">:</span> <span class="c1"># pylint: disable=unidiomatic-typecheck</span>
    <span class="n">dispatch</span><span class="p">[</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_itemgetter</span>

  <span class="k">def</span> <span class="nf">save_attrgetter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;attrgetter serializer&quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">Dummy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
      <span class="k">def</span> <span class="nf">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;attrs&quot;</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
          <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">attrs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">attrs</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">item</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">obj</span><span class="p">(</span><span class="n">Dummy</span><span class="p">(</span><span class="n">attrs</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">attrs</span><span class="p">))</span>

  <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">:</span> <span class="c1"># pylint: disable=unidiomatic-typecheck</span>
    <span class="n">dispatch</span><span class="p">[</span><span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_attrgetter</span>

  <span class="k">def</span> <span class="nf">save_reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="c1"># pylint: disable=too-many-branches</span>
                  <span class="n">listitems</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dictitems</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Modified to support __transient__ on new objects</span>
<span class="sd">    Change only affects protocol level 2 (which is always used by PiCloud&quot;&quot;&quot;</span>
    <span class="c1"># Assert that args is a tuple or None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;args from reduce() should be a tuple&quot;</span><span class="p">)</span>

    <span class="c1"># Assert that func is callable</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39;__call__&#39;</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;func from reduce should be callable&quot;</span><span class="p">)</span>

    <span class="n">save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span>
    <span class="n">write</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span>

    <span class="c1"># Protocol 2 special case: if func&#39;s name is __newobj__, use NEWOBJ</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;__newobj__&quot;</span><span class="p">:</span>
      <span class="c1">#Added fix to allow transient</span>
      <span class="n">cls</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s2">&quot;__new__&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span>
            <span class="s2">&quot;args[0] from __newobj__ args has no __new__&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">__class__</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span>
            <span class="s2">&quot;args[0] from __newobj__ args has the wrong class&quot;</span><span class="p">)</span>
      <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
      <span class="n">save</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>

      <span class="c1">#Don&#39;t pickle transient entries</span>
      <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;__transient__&#39;</span><span class="p">):</span>
        <span class="n">transient</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__transient__</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
          <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">transient</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">state</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

      <span class="n">save</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
      <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">NEWOBJ</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">save</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
      <span class="n">save</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
      <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">REDUCE</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">memoize</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="c1"># More new special cases (that work with older protocols as</span>
    <span class="c1"># well): when __reduce__ returns a tuple with 4 or 5 items,</span>
    <span class="c1"># the 4th and 5th item should be iterators that provide list</span>
    <span class="c1"># items and dict items (as (key, value) tuples), or None.</span>

    <span class="k">if</span> <span class="n">listitems</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_batch_appends</span><span class="p">(</span><span class="n">listitems</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dictitems</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_batch_setitems</span><span class="p">(</span><span class="n">dictitems</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">save</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
      <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">BUILD</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">save_partial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Partial objects do not serialize correctly in python2.x -- this fixes the bugs&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_genpartial</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">keywords</span><span class="p">))</span>

  <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>  <span class="c1"># 2.7 supports partial pickling</span>
    <span class="n">dispatch</span><span class="p">[</span><span class="n">partial</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_partial</span>


  <span class="k">def</span> <span class="nf">save_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span> <span class="c1"># pylint: disable=too-many-branches</span>
    <span class="sd">&quot;&quot;&quot;Save a file&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="kn">import</span> <span class="nn">StringIO</span> <span class="kn">as</span> <span class="nn">pystringIO</span> <span class="c1">#we can&#39;t use cStringIO as it lacks the name attribute</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
      <span class="kn">import</span> <span class="nn">io</span> <span class="kn">as</span> <span class="nn">pystringIO</span> <span class="c1"># pylint: disable=reimported</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="ow">or</span>  <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Cannot pickle files that do not map to an actual file&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="nb">getattr</span><span class="p">,</span> <span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s1">&#39;stdout&#39;</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="nb">getattr</span><span class="p">,</span> <span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s1">&#39;stderr&#39;</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Cannot pickle standard input&quot;</span><span class="p">)</span>
    <span class="k">if</span>  <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;isatty&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">isatty</span><span class="p">():</span>
      <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Cannot pickle files that map to tty objects&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;r&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Cannot pickle files that are not opened for reading&quot;</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">fsize</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Cannot pickle file </span><span class="si">%s</span><span class="s2"> as it cannot be stat&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
      <span class="c1">#create an empty closed string io</span>
      <span class="n">retval</span> <span class="o">=</span> <span class="n">pystringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
      <span class="n">retval</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">fsize</span><span class="p">:</span> <span class="c1">#empty file</span>
      <span class="n">retval</span> <span class="o">=</span> <span class="n">pystringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">tmpfile</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">tst</span> <span class="o">=</span> <span class="n">tmpfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Cannot pickle file </span><span class="si">%s</span><span class="s2"> as it cannot be read&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
      <span class="n">tmpfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">tst</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span>
            <span class="s2">&quot;Cannot pickle file </span><span class="si">%s</span><span class="s2"> as it does not appear to map to a physical, real file&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">tmpfile</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">tmpfile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">tmpfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Cannot pickle file </span><span class="si">%s</span><span class="s2"> as it cannot be read&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
      <span class="n">retval</span> <span class="o">=</span> <span class="n">pystringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
      <span class="n">curloc</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
      <span class="n">retval</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">curloc</span><span class="p">)</span>

    <span class="n">retval</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">retval</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">memoize</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
    <span class="n">dispatch</span><span class="p">[</span><span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_file</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">dispatch</span><span class="p">[</span><span class="nb">file</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_file</span>

  <span class="c1"># Special functions for Add-on libraries</span>

  <span class="k">def</span> <span class="nf">inject_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">numpy</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">numpy</span><span class="p">,</span> <span class="s1">&#39;ufunc&#39;</span><span class="p">):</span>
      <span class="k">return</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ufunc</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">save_ufunc</span>

  <span class="k">def</span> <span class="nf">save_ufunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Hack function for saving numpy ufunc objects&quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__name__</span>
    <span class="n">numpy_tst_mods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;numpy&#39;</span><span class="p">,</span> <span class="s1">&#39;scipy.special&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">tst_mod_name</span> <span class="ow">in</span> <span class="n">numpy_tst_mods</span><span class="p">:</span>
      <span class="n">tst_mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tst_mod_name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">tst_mod</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">tst_mod</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_getobject</span><span class="p">,</span> <span class="p">(</span><span class="n">tst_mod_name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
    <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span>
        <span class="s1">&#39;cannot save </span><span class="si">%s</span><span class="s1">. Cannot resolve what module it is defined in&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">inject_addons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plug in system. Register additional pickling functions if modules already loaded&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">inject_numpy</span><span class="p">()</span>


<span class="c1"># Shorthands for legacy support</span>

<span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">filen</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
  <span class="n">CloudPickler</span><span class="p">(</span><span class="n">filen</span><span class="p">,</span> <span class="n">protocol</span><span class="p">)</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
  <span class="n">filen</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>

  <span class="n">cp</span> <span class="o">=</span> <span class="n">CloudPickler</span><span class="p">(</span><span class="n">filen</span><span class="p">,</span> <span class="n">protocol</span><span class="p">)</span>
  <span class="n">cp</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">filen</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>


<span class="c1">#hack for __import__ not working as desired</span>
<span class="k">def</span> <span class="nf">subimport</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
  <span class="nb">__import__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>


<span class="c1"># restores function attributes</span>
<span class="k">def</span> <span class="nf">_restore_attr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">attr</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">attr</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">obj</span>


<span class="k">def</span> <span class="nf">_get_module_builtins</span><span class="p">():</span>
  <span class="k">return</span> <span class="n">pickle</span><span class="o">.</span><span class="n">__builtins__</span> <span class="c1"># pylint: disable=no-member</span>


<span class="k">def</span> <span class="nf">print_exec</span><span class="p">(</span><span class="n">stream</span><span class="p">):</span>
  <span class="n">ei</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
  <span class="n">traceback</span><span class="o">.</span><span class="n">print_exception</span><span class="p">(</span><span class="n">ei</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ei</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ei</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">None</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_modules_to_main</span><span class="p">(</span><span class="n">modList</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Force every module in modList to be placed into main&quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">modList</span><span class="p">:</span>
    <span class="k">return</span>

  <span class="n">main</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;__main__&#39;</span><span class="p">]</span>
  <span class="k">for</span> <span class="n">modname</span> <span class="ow">in</span> <span class="n">modList</span><span class="p">:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">modname</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">mod</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">modname</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
            <span class="s1">&#39;warning: could not import </span><span class="si">%s</span><span class="se">\n</span><span class="s1">.  &#39;</span>
            <span class="s1">&#39;Your function may unexpectedly error due to this import failing;&#39;</span>
            <span class="s1">&#39;A version mismatch is likely.  Specific error was:</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">modname</span><span class="p">)</span>
        <span class="n">print_exec</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">mod</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">mod</span><span class="p">)</span>


<span class="c1">#object generators:</span>
<span class="k">def</span> <span class="nf">_genpartial</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwds</span><span class="p">):</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">()</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">kwds</span><span class="p">:</span>
    <span class="n">kwds</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">return</span> <span class="n">partial</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_fill_function</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">globalsn</span><span class="p">,</span> <span class="n">defaults</span><span class="p">,</span> <span class="n">dictn</span><span class="p">,</span> <span class="n">module</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; Fills in the rest of function data into the skeleton function object</span>
<span class="sd">    that were created via _make_skel_func().</span>
<span class="sd">     &quot;&quot;&quot;</span>
  <span class="n">func</span><span class="o">.</span><span class="n">__globals__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">globalsn</span><span class="p">)</span>
  <span class="n">func</span><span class="o">.</span><span class="n">__defaults__</span> <span class="o">=</span> <span class="n">defaults</span>
  <span class="n">func</span><span class="o">.</span><span class="n">__dict__</span> <span class="o">=</span> <span class="n">dictn</span>
  <span class="n">func</span><span class="o">.</span><span class="n">__module__</span> <span class="o">=</span> <span class="n">module</span>

  <span class="k">return</span> <span class="n">func</span>


<span class="k">def</span> <span class="nf">_make_cell</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
  <span class="k">return</span> <span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">__closure__</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">_reconstruct_closure</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
  <span class="k">return</span> <span class="nb">tuple</span><span class="p">([</span><span class="n">_make_cell</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">])</span>


<span class="k">def</span> <span class="nf">_make_skel_func</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">closures</span><span class="p">,</span> <span class="n">base_globals</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; Creates a skeleton function object that contains just the provided</span>
<span class="sd">    code and the correct number of cells in func_closure.  All other</span>
<span class="sd">    func attributes (e.g. func_globals) are empty.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">closure</span> <span class="o">=</span> <span class="n">_reconstruct_closure</span><span class="p">(</span><span class="n">closures</span><span class="p">)</span> <span class="k">if</span> <span class="n">closures</span> <span class="k">else</span> <span class="bp">None</span>

  <span class="k">if</span> <span class="n">base_globals</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">base_globals</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="n">base_globals</span><span class="p">[</span><span class="s1">&#39;__builtins__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__builtins__</span>

  <span class="k">return</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">base_globals</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">closure</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_load_class</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Loads additional properties into class `cls`.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
      <span class="n">typ</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
      <span class="k">if</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;property&#39;</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="o">*</span><span class="n">v</span><span class="p">)</span>
      <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;staticmethod&#39;</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nb">staticmethod</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="c1"># pylint: disable=redefined-variable-type</span>
      <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;classmethod&#39;</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nb">classmethod</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="nb">setattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">cls</span>


<span class="k">def</span> <span class="nf">_load_namedtuple</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fields</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Loads a class generated by namedtuple</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
  <span class="k">return</span> <span class="n">namedtuple</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>


<span class="c1"># Constructors for 3rd party libraries</span>
<span class="c1"># Note: These can never be renamed due to client compatibility issues</span>

<span class="k">def</span> <span class="nf">_getobject</span><span class="p">(</span><span class="n">modname</span><span class="p">,</span> <span class="n">attribute</span><span class="p">):</span>
  <span class="n">mod</span> <span class="o">=</span> <span class="nb">__import__</span><span class="p">(</span><span class="n">modname</span><span class="p">,</span> <span class="n">fromlist</span><span class="o">=</span><span class="p">[</span><span class="n">attribute</span><span class="p">])</span>
  <span class="k">return</span> <span class="n">mod</span><span class="o">.</span><span class="n">__dict__</span><span class="p">[</span><span class="n">attribute</span><span class="p">]</span>
</pre></div>

  </div>

  </header>

  <section id="section-items">
    <h2 class="section-title" id="header-variables">Module variables</h2>
      <div class="item">
      <p id="heronpy.api.cloudpickle.DELETE_GLOBAL" class="name">var <span class="ident">DELETE_GLOBAL</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="heronpy.api.cloudpickle.EXTENDED_ARG" class="name">var <span class="ident">EXTENDED_ARG</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="heronpy.api.cloudpickle.GLOBAL_OPS" class="name">var <span class="ident">GLOBAL_OPS</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="heronpy.api.cloudpickle.HAVE_ARGUMENT" class="name">var <span class="ident">HAVE_ARGUMENT</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="heronpy.api.cloudpickle.LOAD_GLOBAL" class="name">var <span class="ident">LOAD_GLOBAL</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="heronpy.api.cloudpickle.PY3" class="name">var <span class="ident">PY3</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="heronpy.api.cloudpickle.STORE_GLOBAL" class="name">var <span class="ident">STORE_GLOBAL</span></p>
      
  
  <div class="source_cont">
</div>

      </div>
      <div class="item">
      <p id="heronpy.api.cloudpickle.k1" class="name">var <span class="ident">k1</span></p>
      
  
  <div class="source_cont">
</div>

      </div>

    <h2 class="section-title" id="header-functions">Functions</h2>
      
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.dump">
    <p>def <span class="ident">dump</span>(</p><p>obj, filen, protocol=2)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.dump', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.dump" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">filen</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
  <span class="n">CloudPickler</span><span class="p">(</span><span class="n">filen</span><span class="p">,</span> <span class="n">protocol</span><span class="p">)</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.dumps">
    <p>def <span class="ident">dumps</span>(</p><p>obj, protocol=2)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.dumps', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.dumps" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
  <span class="n">filen</span> <span class="o">=</span> <span class="n">StringIO</span><span class="p">()</span>

  <span class="n">cp</span> <span class="o">=</span> <span class="n">CloudPickler</span><span class="p">(</span><span class="n">filen</span><span class="p">,</span> <span class="n">protocol</span><span class="p">)</span>
  <span class="n">cp</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">filen</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.islambda">
    <p>def <span class="ident">islambda</span>(</p><p>func)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.islambda', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.islambda" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">islambda</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
  <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39;__name__&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;&lt;lambda&gt;&#39;</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.print_exec">
    <p>def <span class="ident">print_exec</span>(</p><p>stream)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.print_exec', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.print_exec" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">print_exec</span><span class="p">(</span><span class="n">stream</span><span class="p">):</span>
  <span class="n">ei</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
  <span class="n">traceback</span><span class="o">.</span><span class="n">print_exception</span><span class="p">(</span><span class="n">ei</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ei</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ei</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="bp">None</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
      
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.subimport">
    <p>def <span class="ident">subimport</span>(</p><p>name)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.subimport', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.subimport" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">subimport</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
  <span class="nb">__import__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</pre></div>

  </div>
</div>

  </div>
  

    <h2 class="section-title" id="header-classes">Classes</h2>
      
      <div class="item">
      <p id="heronpy.api.cloudpickle.CloudPickler" class="name">class <span class="ident">CloudPickler</span></p>
      
  
    <div class="desc"><p>CloudPickler class</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler" class="source">
    <div class="codehilite"><pre><span></span><span class="k">class</span> <span class="nc">CloudPickler</span><span class="p">(</span><span class="n">Pickler</span><span class="p">):</span> <span class="c1"># pylint: disable=too-many-public-methods</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  CloudPickler class</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">dispatch</span> <span class="o">=</span> <span class="n">Pickler</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filen</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">Pickler</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filen</span><span class="p">,</span> <span class="n">protocol</span><span class="p">)</span>
    <span class="c1"># set of modules to unpickle</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">modules</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="c1"># map ids to dictionary. used to ensure that functions can share global env</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">globals_ref</span> <span class="o">=</span> <span class="p">{}</span>

  <span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">inject_addons</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">Pickler</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="k">if</span> <span class="s1">&#39;recursion&#39;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Could not pickle object as excessively deep recursion required.&quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PickleError</span><span class="p">:</span>
      <span class="k">raise</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">print_exec</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
      <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">save_memoryview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fallback to save_string&quot;&quot;&quot;</span>
    <span class="n">Pickler</span><span class="o">.</span><span class="n">save_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">save_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fallback to save_string&quot;&quot;&quot;</span>
    <span class="n">Pickler</span><span class="o">.</span><span class="n">save_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
  <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
    <span class="n">dispatch</span><span class="p">[</span><span class="n">memoryview</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_memoryview</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">dispatch</span><span class="p">[</span><span class="nb">buffer</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_buffer</span>

  <span class="k">def</span> <span class="nf">save_unsupported</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span> <span class="c1"># pylint: disable=no-self-use</span>
    <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Cannot pickle objects of type </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
  <span class="n">dispatch</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">GeneratorType</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_unsupported</span>

  <span class="c1"># itertools objects do not pickle!</span>
  <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">:</span> <span class="c1"># pylint: disable=unidiomatic-typecheck</span>
      <span class="n">dispatch</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_unsupported</span>

  <span class="k">def</span> <span class="nf">save_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save a module as an import</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">subimport</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__name__</span><span class="p">,),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
  <span class="n">dispatch</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_module</span>

  <span class="k">def</span> <span class="nf">save_codeobject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save a code object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
      <span class="n">args</span> <span class="o">=</span> <span class="p">(</span>
          <span class="n">obj</span><span class="o">.</span><span class="n">co_argcount</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_kwonlyargcount</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_nlocals</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_stacksize</span><span class="p">,</span>
          <span class="n">obj</span><span class="o">.</span><span class="n">co_flags</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_code</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_consts</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_names</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">,</span>
          <span class="n">obj</span><span class="o">.</span><span class="n">co_filename</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_firstlineno</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_lnotab</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_freevars</span><span class="p">,</span>
          <span class="n">obj</span><span class="o">.</span><span class="n">co_cellvars</span>
      <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">args</span> <span class="o">=</span> <span class="p">(</span>
          <span class="n">obj</span><span class="o">.</span><span class="n">co_argcount</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_nlocals</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_stacksize</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_flags</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_code</span><span class="p">,</span>
          <span class="n">obj</span><span class="o">.</span><span class="n">co_consts</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_names</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_filename</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span>
          <span class="n">obj</span><span class="o">.</span><span class="n">co_firstlineno</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_lnotab</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_freevars</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_cellvars</span>
      <span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">CodeType</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
  <span class="n">dispatch</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">CodeType</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_codeobject</span>

  <span class="k">def</span> <span class="nf">save_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Registered with the dispatch to handle all function types.</span>
<span class="sd">    Determines what kind of function obj is (e.g. lambda, defined at</span>
<span class="sd">    interactive prompt, etc) and handles the pickling appropriately.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">write</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__name__</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="c1"># whichmodule() could fail, see</span>
      <span class="c1"># https://bitbucket.org/gutworth/six/issues/63/importing-six-breaks-pickling</span>
      <span class="n">modname</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">whichmodule</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
      <span class="n">modname</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="c1"># print(&#39;which gives %s %s %s&#39; % (modname, obj, name))</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">themodule</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">modname</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
      <span class="c1"># eval&#39;d items such as namedtuple give invalid items for their function __module__</span>
      <span class="n">modname</span> <span class="o">=</span> <span class="s1">&#39;__main__&#39;</span>

    <span class="k">if</span> <span class="n">modname</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
      <span class="n">themodule</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">if</span> <span class="n">themodule</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">themodule</span><span class="p">)</span>
      <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">themodule</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="n">obj</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_global</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="c1"># if func is lambda, def&#39;ed at prompt, is in main, or is nested, then</span>
    <span class="c1"># we&#39;ll pickle the actual function object rather than simply saving a</span>
    <span class="c1"># reference (as is done in default pickler), via save_function_tuple.</span>
    <span class="k">if</span> <span class="n">islambda</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">__code__</span><span class="o">.</span><span class="n">co_filename</span> <span class="o">==</span> <span class="s1">&#39;&lt;stdin&gt;&#39;</span> <span class="ow">or</span> <span class="n">themodule</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="c1">#print(&quot;save global&quot;, islambda(obj), obj.__code__.co_filename, modname, themodule)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">save_function_tuple</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
      <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="c1"># func is nested</span>
      <span class="n">klass</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">themodule</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">klass</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">klass</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_function_tuple</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
      <span class="c1"># essentially save_reduce, but workaround needed to avoid recursion</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">_restore_attr</span><span class="p">)</span>
      <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">MARK</span> <span class="o">+</span> <span class="n">pickle</span><span class="o">.</span><span class="n">GLOBAL</span> <span class="o">+</span> <span class="n">modname</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">memoize</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
      <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">TUPLE</span> <span class="o">+</span> <span class="n">pickle</span><span class="o">.</span><span class="n">REDUCE</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">GLOBAL</span> <span class="o">+</span> <span class="n">modname</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">memoize</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
  <span class="n">dispatch</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_function</span>

  <span class="k">def</span> <span class="nf">save_function_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;  Pickles an actual func object.</span>
<span class="sd">    A func comprises: code, globals, defaults, closure, and dict.  We</span>
<span class="sd">    extract and save these, injecting reducing functions at certain points</span>
<span class="sd">    to recreate the func object.  Keep in mind that some of these pieces</span>
<span class="sd">    can contain a ref to the func itself.  Thus, a naive save on these</span>
<span class="sd">    pieces could trigger an infinite loop of save&#39;s.  To get around that,</span>
<span class="sd">    we first create a skeleton func object using just the code (this is</span>
<span class="sd">    safe, since this won&#39;t contain a ref to the func), and memoize it as</span>
<span class="sd">    soon as it&#39;s created.  The other stuff can then be filled in later.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span>
    <span class="n">write</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span>

    <span class="n">code</span><span class="p">,</span> <span class="n">f_globals</span><span class="p">,</span> <span class="n">defaults</span><span class="p">,</span> <span class="n">closure</span><span class="p">,</span> <span class="n">dct</span><span class="p">,</span> <span class="n">base_globals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_func_data</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

    <span class="n">save</span><span class="p">(</span><span class="n">_fill_function</span><span class="p">)</span>  <span class="c1"># skeleton function updater</span>
    <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">MARK</span><span class="p">)</span>    <span class="c1"># beginning of tuple that _fill_function expects</span>

    <span class="c1"># create a skeleton function object and memoize it</span>
    <span class="n">save</span><span class="p">(</span><span class="n">_make_skel_func</span><span class="p">)</span>
    <span class="n">save</span><span class="p">((</span><span class="n">code</span><span class="p">,</span> <span class="n">closure</span><span class="p">,</span> <span class="n">base_globals</span><span class="p">))</span>
    <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">REDUCE</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">memoize</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

    <span class="c1"># save the rest of the func data needed by _fill_function</span>
    <span class="n">save</span><span class="p">(</span><span class="n">f_globals</span><span class="p">)</span>
    <span class="n">save</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span>
    <span class="n">save</span><span class="p">(</span><span class="n">dct</span><span class="p">)</span>
    <span class="n">save</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">__module__</span><span class="p">)</span>
    <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">TUPLE</span><span class="p">)</span>
    <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">REDUCE</span><span class="p">)</span>  <span class="c1"># applies _fill_function on the tuple</span>

  <span class="n">_extract_code_globals_cache</span> <span class="o">=</span> <span class="p">(</span>
      <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s2">&quot;pypy_version_info&quot;</span><span class="p">)</span>
      <span class="k">else</span> <span class="p">{}</span>
  <span class="p">)</span>

  <span class="nd">@classmethod</span>
  <span class="k">def</span> <span class="nf">extract_code_globals</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">co</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find all globals names read or written to by codeblock co</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out_names</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_extract_code_globals_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">co</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">out_names</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">co</span><span class="o">.</span><span class="n">co_names</span>
      <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="c1"># PyPy &quot;builtin-code&quot; object</span>
        <span class="n">out_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">out_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">oparg</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">oparg</span> <span class="ow">in</span> <span class="n">_walk_global_ops</span><span class="p">(</span><span class="n">co</span><span class="p">))</span>

        <span class="c1"># see if nested function have any global refs</span>
        <span class="k">if</span> <span class="n">co</span><span class="o">.</span><span class="n">co_consts</span><span class="p">:</span>
          <span class="k">for</span> <span class="n">const</span> <span class="ow">in</span> <span class="n">co</span><span class="o">.</span><span class="n">co_consts</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">const</span><span class="p">)</span> <span class="ow">is</span> <span class="n">types</span><span class="o">.</span><span class="n">CodeType</span><span class="p">:</span> <span class="c1"># pylint: disable=unidiomatic-typecheck</span>
              <span class="n">out_names</span> <span class="o">|=</span> <span class="n">cls</span><span class="o">.</span><span class="n">extract_code_globals</span><span class="p">(</span><span class="n">const</span><span class="p">)</span>

      <span class="n">cls</span><span class="o">.</span><span class="n">_extract_code_globals_cache</span><span class="p">[</span><span class="n">co</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_names</span>

    <span class="k">return</span> <span class="n">out_names</span>

  <span class="k">def</span> <span class="nf">extract_func_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Turn the function into a tuple of data necessary to recreate it:</span>
<span class="sd">      code, globals, defaults, closure, dict</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__code__</span>

    <span class="c1"># extract all global ref&#39;s</span>
    <span class="n">func_global_refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_code_globals</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

    <span class="c1"># process all variables referenced by global environment</span>
    <span class="n">f_globals</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">func_global_refs</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">func</span><span class="o">.</span><span class="n">__globals__</span><span class="p">:</span>
        <span class="n">f_globals</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__globals__</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>

    <span class="c1"># defaults requires no processing</span>
    <span class="n">defaults</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__defaults__</span>

    <span class="c1"># process closure</span>
    <span class="n">closure</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">cell_contents</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">func</span><span class="o">.</span><span class="n">__closure__</span><span class="p">]</span> <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="n">__closure__</span> <span class="k">else</span> <span class="p">[]</span>

    <span class="c1"># save the dict</span>
    <span class="n">dct</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__dict__</span>

    <span class="n">base_globals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals_ref</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">__globals__</span><span class="p">),</span> <span class="p">{})</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">globals_ref</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">__globals__</span><span class="p">)]</span> <span class="o">=</span> <span class="n">base_globals</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">f_globals</span><span class="p">,</span> <span class="n">defaults</span><span class="p">,</span> <span class="n">closure</span><span class="p">,</span> <span class="n">dct</span><span class="p">,</span> <span class="n">base_globals</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">save_builtin_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">__module__</span> <span class="ow">is</span> <span class="s2">&quot;__builtin__&quot;</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_global</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_function</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
  <span class="n">dispatch</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">BuiltinFunctionType</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_builtin_function</span>

  <span class="k">def</span> <span class="nf">save_global</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pack</span><span class="o">=</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">):</span> <span class="c1"># pylint: disable=too-many-branches</span>
    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">__module__</span> <span class="o">==</span> <span class="s2">&quot;__builtin__&quot;</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">__module__</span> <span class="o">==</span> <span class="s2">&quot;builtins&quot;</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">_BUILTIN_TYPE_NAMES</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_builtin_type</span><span class="p">,</span> <span class="p">(</span><span class="n">_BUILTIN_TYPE_NAMES</span><span class="p">[</span><span class="n">obj</span><span class="p">],),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__name__</span>

    <span class="n">modname</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">modname</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="c1"># whichmodule() could fail, see</span>
        <span class="c1"># https://bitbucket.org/gutworth/six/issues/63/importing-six-breaks-pickling</span>
        <span class="n">modname</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">whichmodule</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">modname</span> <span class="o">=</span> <span class="s1">&#39;__main__&#39;</span>

    <span class="k">if</span> <span class="n">modname</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
      <span class="n">themodule</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="nb">__import__</span><span class="p">(</span><span class="n">modname</span><span class="p">)</span>
      <span class="n">themodule</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">modname</span><span class="p">]</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">themodule</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">themodule</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">themodule</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="n">obj</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">Pickler</span><span class="o">.</span><span class="n">save_global</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>

    <span class="n">typ</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">obj</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ClassType</span><span class="p">)):</span>
      <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>  <span class="c1"># copy dict proxy to a dict</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;__dict__&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="nb">property</span><span class="p">):</span>
        <span class="c1"># don&#39;t extract dict that are properties</span>
        <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;__dict__&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
      <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;__weakref__&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

      <span class="c1"># hack as __new__ is stored differently in the __dict__</span>
      <span class="n">new_override</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;__new__&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">new_override</span><span class="p">:</span>
        <span class="n">d</span><span class="p">[</span><span class="s1">&#39;__new__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__new__</span>

      <span class="c1"># workaround for namedtuple (hijacked by PySpark)</span>
      <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;_is_namedtuple_&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_load_namedtuple</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_fields</span><span class="p">))</span>
        <span class="k">return</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">_load_class</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">__bases__</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;__doc__&quot;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">__doc__</span><span class="p">}),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
      <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;__doc__&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
      <span class="c1"># handle property and staticmethod</span>
      <span class="n">dd</span> <span class="o">=</span> <span class="p">{}</span>
      <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">property</span><span class="p">):</span>
          <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;property&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
          <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">fget</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">fset</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">fdel</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">__doc__</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">staticmethod</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;__func__&#39;</span><span class="p">):</span>
          <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;staticmethod&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
          <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">__func__</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">classmethod</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;__func__&#39;</span><span class="p">):</span>
          <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;classmethod&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
          <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">__func__</span>
        <span class="n">dd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">TUPLE2</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">REDUCE</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t pickle </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>

  <span class="n">dispatch</span><span class="p">[</span><span class="nb">type</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_global</span>
  <span class="n">dispatch</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">ClassType</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_global</span>

  <span class="k">def</span> <span class="nf">save_instancemethod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="c1"># Memoization rarely is ever useful due to python bounding</span>
    <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__func__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">__self__</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span>
          <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__func__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">__self__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">__self__</span><span class="o">.</span><span class="n">__class__</span><span class="p">),</span>
          <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
  <span class="n">dispatch</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_instancemethod</span>

  <span class="k">def</span> <span class="nf">save_inst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Inner logic to save instance. Based off pickle.save_inst</span>
<span class="sd">    Supports __transient__&quot;&quot;&quot;</span>
    <span class="n">cls</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__class__</span>

    <span class="n">memo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memo</span>
    <span class="n">write</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span>
    <span class="n">save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;__getinitargs__&#39;</span><span class="p">):</span>
      <span class="n">args</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__getinitargs__</span><span class="p">()</span>
      <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>  <span class="c1"># assert it&#39;s a sequence</span>
      <span class="n">pickle</span><span class="o">.</span><span class="n">_keep_alive</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="c1"># pylint: disable=protected-access</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">args</span> <span class="o">=</span> <span class="p">()</span>

    <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">MARK</span><span class="p">)</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin</span><span class="p">:</span>
      <span class="n">save</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
      <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">save</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
      <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">OBJ</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="n">save</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
      <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">INST</span> <span class="o">+</span> <span class="n">cls</span><span class="o">.</span><span class="n">__module__</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">cls</span><span class="o">.</span><span class="n">__name__</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">memoize</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
      <span class="n">getstate</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__getstate__</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="n">stuff</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span>
      <span class="c1">#remove items if transient</span>
      <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;__transient__&#39;</span><span class="p">):</span>
        <span class="n">transient</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__transient__</span>
        <span class="n">stuff</span> <span class="o">=</span> <span class="n">stuff</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">stuff</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
          <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">transient</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">stuff</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">stuff</span> <span class="o">=</span> <span class="n">getstate</span><span class="p">()</span>
      <span class="n">pickle</span><span class="o">.</span><span class="n">_keep_alive</span><span class="p">(</span><span class="n">stuff</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="c1"># pylint: disable=protected-access</span>
    <span class="n">save</span><span class="p">(</span><span class="n">stuff</span><span class="p">)</span>
    <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">BUILD</span><span class="p">)</span>

  <span class="k">if</span> <span class="ow">not</span> <span class="n">PY3</span><span class="p">:</span>
    <span class="n">dispatch</span><span class="p">[</span><span class="n">types</span><span class="o">.</span><span class="n">InstanceType</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_inst</span>

  <span class="k">def</span> <span class="nf">save_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="c1"># properties not correctly saved in python</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="nb">property</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">fget</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">fset</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">fdel</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">__doc__</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
  <span class="n">dispatch</span><span class="p">[</span><span class="nb">property</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_property</span>

  <span class="k">def</span> <span class="nf">save_itemgetter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;itemgetter serializer (needed for namedtuple support)&quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">Dummy</span><span class="p">:</span> <span class="c1"># pylint: disable=old-style-class</span>
      <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
      <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">item</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">obj</span><span class="p">(</span><span class="n">Dummy</span><span class="p">())</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
      <span class="n">items</span> <span class="o">=</span> <span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>

  <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">:</span> <span class="c1"># pylint: disable=unidiomatic-typecheck</span>
    <span class="n">dispatch</span><span class="p">[</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_itemgetter</span>

  <span class="k">def</span> <span class="nf">save_attrgetter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;attrgetter serializer&quot;&quot;&quot;</span>
    <span class="k">class</span> <span class="nc">Dummy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
      <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
      <span class="k">def</span> <span class="nf">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="n">attrs</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;attrs&quot;</span><span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
          <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
          <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="n">attrs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">attrs</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">item</span><span class="p">])</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
    <span class="n">attrs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">obj</span><span class="p">(</span><span class="n">Dummy</span><span class="p">(</span><span class="n">attrs</span><span class="p">))</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">attrs</span><span class="p">))</span>

  <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">type</span><span class="p">:</span> <span class="c1"># pylint: disable=unidiomatic-typecheck</span>
    <span class="n">dispatch</span><span class="p">[</span><span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_attrgetter</span>

  <span class="k">def</span> <span class="nf">save_reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="c1"># pylint: disable=too-many-branches</span>
                  <span class="n">listitems</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dictitems</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Modified to support __transient__ on new objects</span>
<span class="sd">    Change only affects protocol level 2 (which is always used by PiCloud&quot;&quot;&quot;</span>
    <span class="c1"># Assert that args is a tuple or None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;args from reduce() should be a tuple&quot;</span><span class="p">)</span>

    <span class="c1"># Assert that func is callable</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39;__call__&#39;</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;func from reduce should be callable&quot;</span><span class="p">)</span>

    <span class="n">save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span>
    <span class="n">write</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span>

    <span class="c1"># Protocol 2 special case: if func&#39;s name is __newobj__, use NEWOBJ</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;__newobj__&quot;</span><span class="p">:</span>
      <span class="c1">#Added fix to allow transient</span>
      <span class="n">cls</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s2">&quot;__new__&quot;</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span>
            <span class="s2">&quot;args[0] from __newobj__ args has no __new__&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">__class__</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span>
            <span class="s2">&quot;args[0] from __newobj__ args has the wrong class&quot;</span><span class="p">)</span>
      <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
      <span class="n">save</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>

      <span class="c1">#Don&#39;t pickle transient entries</span>
      <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;__transient__&#39;</span><span class="p">):</span>
        <span class="n">transient</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__transient__</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
          <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">transient</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">state</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

      <span class="n">save</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
      <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">NEWOBJ</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">save</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
      <span class="n">save</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
      <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">REDUCE</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">memoize</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

    <span class="c1"># More new special cases (that work with older protocols as</span>
    <span class="c1"># well): when __reduce__ returns a tuple with 4 or 5 items,</span>
    <span class="c1"># the 4th and 5th item should be iterators that provide list</span>
    <span class="c1"># items and dict items (as (key, value) tuples), or None.</span>

    <span class="k">if</span> <span class="n">listitems</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_batch_appends</span><span class="p">(</span><span class="n">listitems</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dictitems</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_batch_setitems</span><span class="p">(</span><span class="n">dictitems</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">save</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
      <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">BUILD</span><span class="p">)</span>

  <span class="k">def</span> <span class="nf">save_partial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Partial objects do not serialize correctly in python2.x -- this fixes the bugs&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_genpartial</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">keywords</span><span class="p">))</span>

  <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>  <span class="c1"># 2.7 supports partial pickling</span>
    <span class="n">dispatch</span><span class="p">[</span><span class="n">partial</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_partial</span>


  <span class="k">def</span> <span class="nf">save_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span> <span class="c1"># pylint: disable=too-many-branches</span>
    <span class="sd">&quot;&quot;&quot;Save a file&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="kn">import</span> <span class="nn">StringIO</span> <span class="kn">as</span> <span class="nn">pystringIO</span> <span class="c1">#we can&#39;t use cStringIO as it lacks the name attribute</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
      <span class="kn">import</span> <span class="nn">io</span> <span class="kn">as</span> <span class="nn">pystringIO</span> <span class="c1"># pylint: disable=reimported</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="ow">or</span>  <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Cannot pickle files that do not map to an actual file&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="nb">getattr</span><span class="p">,</span> <span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s1">&#39;stdout&#39;</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="nb">getattr</span><span class="p">,</span> <span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s1">&#39;stderr&#39;</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Cannot pickle standard input&quot;</span><span class="p">)</span>
    <span class="k">if</span>  <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;isatty&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">isatty</span><span class="p">():</span>
      <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Cannot pickle files that map to tty objects&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="s1">&#39;r&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Cannot pickle files that are not opened for reading&quot;</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">fsize</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span>
    <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Cannot pickle file </span><span class="si">%s</span><span class="s2"> as it cannot be stat&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
      <span class="c1">#create an empty closed string io</span>
      <span class="n">retval</span> <span class="o">=</span> <span class="n">pystringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
      <span class="n">retval</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">fsize</span><span class="p">:</span> <span class="c1">#empty file</span>
      <span class="n">retval</span> <span class="o">=</span> <span class="n">pystringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">tmpfile</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">tst</span> <span class="o">=</span> <span class="n">tmpfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Cannot pickle file </span><span class="si">%s</span><span class="s2"> as it cannot be read&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
      <span class="n">tmpfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">tst</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span>
            <span class="s2">&quot;Cannot pickle file </span><span class="si">%s</span><span class="s2"> as it does not appear to map to a physical, real file&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">tmpfile</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">contents</span> <span class="o">=</span> <span class="n">tmpfile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="n">tmpfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Cannot pickle file </span><span class="si">%s</span><span class="s2"> as it cannot be read&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
      <span class="n">retval</span> <span class="o">=</span> <span class="n">pystringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
      <span class="n">curloc</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
      <span class="n">retval</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">curloc</span><span class="p">)</span>

    <span class="n">retval</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">retval</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">memoize</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

  <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
    <span class="n">dispatch</span><span class="p">[</span><span class="n">io</span><span class="o">.</span><span class="n">TextIOWrapper</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_file</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">dispatch</span><span class="p">[</span><span class="nb">file</span><span class="p">]</span> <span class="o">=</span> <span class="n">save_file</span>

  <span class="c1"># Special functions for Add-on libraries</span>

  <span class="k">def</span> <span class="nf">inject_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">numpy</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">numpy</span><span class="p">,</span> <span class="s1">&#39;ufunc&#39;</span><span class="p">):</span>
      <span class="k">return</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ufunc</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">save_ufunc</span>

  <span class="k">def</span> <span class="nf">save_ufunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Hack function for saving numpy ufunc objects&quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__name__</span>
    <span class="n">numpy_tst_mods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;numpy&#39;</span><span class="p">,</span> <span class="s1">&#39;scipy.special&#39;</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">tst_mod_name</span> <span class="ow">in</span> <span class="n">numpy_tst_mods</span><span class="p">:</span>
      <span class="n">tst_mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tst_mod_name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">tst_mod</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">tst_mod</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_getobject</span><span class="p">,</span> <span class="p">(</span><span class="n">tst_mod_name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
    <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span>
        <span class="s1">&#39;cannot save </span><span class="si">%s</span><span class="s1">. Cannot resolve what module it is defined in&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>

  <span class="k">def</span> <span class="nf">inject_addons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plug in system. Register additional pickling functions if modules already loaded&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">inject_numpy</span><span class="p">()</span>
</pre></div>

  </div>
</div>


      <div class="class">
          <h3>Ancestors (in MRO)</h3>
          <ul class="class_list">
          <li><a href="#heronpy.api.cloudpickle.CloudPickler">CloudPickler</a></li>
          <li>pickle.Pickler</li>
          </ul>
          <h3>Class variables</h3>
            <div class="item">
            <p id="heronpy.api.cloudpickle.CloudPickler.dispatch" class="name">var <span class="ident">dispatch</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="heronpy.api.cloudpickle.CloudPickler.v" class="name">var <span class="ident">v</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
          <h3>Instance variables</h3>
            <div class="item">
            <p id="heronpy.api.cloudpickle.CloudPickler.globals_ref" class="name">var <span class="ident">globals_ref</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
            <div class="item">
            <p id="heronpy.api.cloudpickle.CloudPickler.modules" class="name">var <span class="ident">modules</span></p>
            

            
  
  <div class="source_cont">
</div>

            </div>
          <h3>Methods</h3>
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.__init__">
    <p>def <span class="ident">__init__</span>(</p><p>self, filen, protocol=None)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.__init__', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.__init__" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filen</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
  <span class="n">Pickler</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filen</span><span class="p">,</span> <span class="n">protocol</span><span class="p">)</span>
  <span class="c1"># set of modules to unpickle</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">modules</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
  <span class="c1"># map ids to dictionary. used to ensure that functions can share global env</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">globals_ref</span> <span class="o">=</span> <span class="p">{}</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.clear_memo">
    <p>def <span class="ident">clear_memo</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Clears the pickler's "memo".</p>
<p>The memo is the data structure that remembers which objects the
pickler has already seen, so that shared or recursive objects are
pickled by reference and not by value.  This method is useful when
re-using picklers.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.clear_memo', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.clear_memo" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">clear_memo</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Clears the pickler&#39;s &quot;memo&quot;.</span>
<span class="sd">    The memo is the data structure that remembers which objects the</span>
<span class="sd">    pickler has already seen, so that shared or recursive objects are</span>
<span class="sd">    pickled by reference and not by value.  This method is useful when</span>
<span class="sd">    re-using picklers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">memo</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.dump">
    <p>def <span class="ident">dump</span>(</p><p>self, obj)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.dump', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.dump" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">inject_addons</span><span class="p">()</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">Pickler</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
  <span class="k">except</span> <span class="ne">RuntimeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="k">if</span> <span class="s1">&#39;recursion&#39;</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;Could not pickle object as excessively deep recursion required.&quot;&quot;&quot;</span>
      <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
  <span class="k">except</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PickleError</span><span class="p">:</span>
    <span class="k">raise</span>
  <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
    <span class="n">print_exec</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.extract_code_globals">
    <p>def <span class="ident">extract_code_globals</span>(</p><p>cls, co)</p>
    </div>
    

    
  
    <div class="desc"><p>Find all globals names read or written to by codeblock co</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.extract_code_globals', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.extract_code_globals" class="source">
    <div class="codehilite"><pre><span></span><span class="nd">@classmethod</span>
<span class="k">def</span> <span class="nf">extract_code_globals</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="n">co</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Find all globals names read or written to by codeblock co</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">out_names</span> <span class="o">=</span> <span class="n">cls</span><span class="o">.</span><span class="n">_extract_code_globals_cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">co</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">out_names</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">names</span> <span class="o">=</span> <span class="n">co</span><span class="o">.</span><span class="n">co_names</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
      <span class="c1"># PyPy &quot;builtin-code&quot; object</span>
      <span class="n">out_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">out_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">names</span><span class="p">[</span><span class="n">oparg</span><span class="p">]</span>
                      <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">oparg</span> <span class="ow">in</span> <span class="n">_walk_global_ops</span><span class="p">(</span><span class="n">co</span><span class="p">))</span>
      <span class="c1"># see if nested function have any global refs</span>
      <span class="k">if</span> <span class="n">co</span><span class="o">.</span><span class="n">co_consts</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">const</span> <span class="ow">in</span> <span class="n">co</span><span class="o">.</span><span class="n">co_consts</span><span class="p">:</span>
          <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">const</span><span class="p">)</span> <span class="ow">is</span> <span class="n">types</span><span class="o">.</span><span class="n">CodeType</span><span class="p">:</span> <span class="c1"># pylint: disable=unidiomatic-typecheck</span>
            <span class="n">out_names</span> <span class="o">|=</span> <span class="n">cls</span><span class="o">.</span><span class="n">extract_code_globals</span><span class="p">(</span><span class="n">const</span><span class="p">)</span>
    <span class="n">cls</span><span class="o">.</span><span class="n">_extract_code_globals_cache</span><span class="p">[</span><span class="n">co</span><span class="p">]</span> <span class="o">=</span> <span class="n">out_names</span>
  <span class="k">return</span> <span class="n">out_names</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.extract_func_data">
    <p>def <span class="ident">extract_func_data</span>(</p><p>self, func)</p>
    </div>
    

    
  
    <div class="desc"><p>Turn the function into a tuple of data necessary to recreate it:
code, globals, defaults, closure, dict</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.extract_func_data', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.extract_func_data" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">extract_func_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Turn the function into a tuple of data necessary to recreate it:</span>
<span class="sd">    code, globals, defaults, closure, dict</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">code</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__code__</span>
  <span class="c1"># extract all global ref&#39;s</span>
  <span class="n">func_global_refs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_code_globals</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
  <span class="c1"># process all variables referenced by global environment</span>
  <span class="n">f_globals</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">func_global_refs</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">func</span><span class="o">.</span><span class="n">__globals__</span><span class="p">:</span>
      <span class="n">f_globals</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__globals__</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
  <span class="c1"># defaults requires no processing</span>
  <span class="n">defaults</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__defaults__</span>
  <span class="c1"># process closure</span>
  <span class="n">closure</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">cell_contents</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">func</span><span class="o">.</span><span class="n">__closure__</span><span class="p">]</span> <span class="k">if</span> <span class="n">func</span><span class="o">.</span><span class="n">__closure__</span> <span class="k">else</span> <span class="p">[]</span>
  <span class="c1"># save the dict</span>
  <span class="n">dct</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="n">__dict__</span>
  <span class="n">base_globals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">globals_ref</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">__globals__</span><span class="p">),</span> <span class="p">{})</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">globals_ref</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">__globals__</span><span class="p">)]</span> <span class="o">=</span> <span class="n">base_globals</span>
  <span class="k">return</span> <span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">f_globals</span><span class="p">,</span> <span class="n">defaults</span><span class="p">,</span> <span class="n">closure</span><span class="p">,</span> <span class="n">dct</span><span class="p">,</span> <span class="n">base_globals</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.get">
    <p>def <span class="ident">get</span>(</p><p>self, i, pack=&lt;built-in function pack&gt;)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.get', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.get" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">pack</span><span class="o">=</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BINGET</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">LONG_BINGET</span> <span class="o">+</span> <span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;i&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">GET</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.inject_addons">
    <p>def <span class="ident">inject_addons</span>(</p><p>self)</p>
    </div>
    

    
  
    <div class="desc"><p>Plug in system. Register additional pickling functions if modules already loaded</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.inject_addons', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.inject_addons" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">inject_addons</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Plug in system. Register additional pickling functions if modules already loaded&quot;&quot;&quot;</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">inject_numpy</span><span class="p">()</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.inject_numpy">
    <p>def <span class="ident">inject_numpy</span>(</p><p>self)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.inject_numpy', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.inject_numpy" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">inject_numpy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
  <span class="n">numpy</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;numpy&#39;</span><span class="p">)</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="n">numpy</span> <span class="ow">or</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">numpy</span><span class="p">,</span> <span class="s1">&#39;ufunc&#39;</span><span class="p">):</span>
    <span class="k">return</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">ufunc</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">save_ufunc</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.memoize">
    <p>def <span class="ident">memoize</span>(</p><p>self, obj)</p>
    </div>
    

    
  
    <div class="desc"><p>Store an object in the memo.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.memoize', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.memoize" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">memoize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Store an object in the memo.&quot;&quot;&quot;</span>
    <span class="c1"># The Pickler memo is a dictionary mapping object ids to 2-tuples</span>
    <span class="c1"># that contain the Unpickler memo key and the object being memoized.</span>
    <span class="c1"># The memo key is written to the pickle and will become</span>
    <span class="c1"># the key in the Unpickler&#39;s memo.  The object is stored in the</span>
    <span class="c1"># Pickler memo so that transient objects are kept alive during</span>
    <span class="c1"># pickling.</span>
    <span class="c1"># The use of the Unpickler memo length as the memo key is just a</span>
    <span class="c1"># convention.  The only requirement is that the memo values be unique.</span>
    <span class="c1"># But there appears no advantage to any other scheme, and this</span>
    <span class="c1"># scheme allows the Unpickler memo to be implemented as a plain (but</span>
    <span class="c1"># growable) array, indexed by memo key.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fast</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">assert</span> <span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">memo</span>
    <span class="n">memo_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memo</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">memo_len</span><span class="p">))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">memo</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">)]</span> <span class="o">=</span> <span class="n">memo_len</span><span class="p">,</span> <span class="n">obj</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.persistent_id">
    <p>def <span class="ident">persistent_id</span>(</p><p>self, obj)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.persistent_id', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.persistent_id" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">persistent_id</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="c1"># This exists so a subclass can override it</span>
    <span class="k">return</span> <span class="bp">None</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.put">
    <p>def <span class="ident">put</span>(</p><p>self, i, pack=&lt;built-in function pack&gt;)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.put', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.put" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">put</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">pack</span><span class="o">=</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">BINPUT</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">LONG_BINPUT</span> <span class="o">+</span> <span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;i&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">PUT</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save">
    <p>def <span class="ident">save</span>(</p><p>self, obj)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="c1"># Check for persistent id (defined by a subclass)</span>
    <span class="n">pid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">persistent_id</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">pid</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_pers</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="c1"># Check the memo</span>
    <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memo</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">x</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">return</span>
    <span class="c1"># Check the type dispatch table</span>
    <span class="n">t</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span> <span class="c1"># Call unbound method with explicit self</span>
        <span class="k">return</span>
    <span class="c1"># Check copy_reg.dispatch_table</span>
    <span class="nb">reduce</span> <span class="o">=</span> <span class="n">dispatch_table</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">reduce</span><span class="p">:</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="nb">reduce</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Check for a class with a custom metaclass; treat as regular class</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">issc</span> <span class="o">=</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">TypeType</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span> <span class="c1"># t is not a class (old Boost; see SF #502085)</span>
            <span class="n">issc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">issc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_global</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="c1"># Check for a __reduce_ex__ method, fall back to __reduce__</span>
        <span class="nb">reduce</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__reduce_ex__&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">reduce</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="nb">reduce</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">proto</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">reduce</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__reduce__&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">reduce</span><span class="p">:</span>
                <span class="n">rv</span> <span class="o">=</span> <span class="nb">reduce</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t pickle </span><span class="si">%r</span><span class="s2"> object: </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span>
                                    <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>
    <span class="c1"># Check for string returned by reduce(), meaning &quot;save as global&quot;</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="ow">is</span> <span class="n">StringType</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_global</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">rv</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="c1"># Assert that reduce() returned a tuple</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">TupleType</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> must return string or tuple&quot;</span> <span class="o">%</span> <span class="nb">reduce</span><span class="p">)</span>
    <span class="c1"># Assert that it returned an appropriately sized tuple</span>
    <span class="n">l</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;=</span> <span class="n">l</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Tuple returned by </span><span class="si">%s</span><span class="s2"> must have &quot;</span>
                            <span class="s2">&quot;two to five elements&quot;</span> <span class="o">%</span> <span class="nb">reduce</span><span class="p">)</span>
    <span class="c1"># Save the reduce() output and finally memoize the object</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="o">*</span><span class="n">rv</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_attrgetter">
    <p>def <span class="ident">save_attrgetter</span>(</p><p>self, obj)</p>
    </div>
    

    
  
    <div class="desc"><p>attrgetter serializer</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_attrgetter', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_attrgetter" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_attrgetter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;attrgetter serializer&quot;&quot;&quot;</span>
  <span class="k">class</span> <span class="nc">Dummy</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">attrs</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
    <span class="k">def</span> <span class="nf">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
      <span class="n">attrs</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;attrs&quot;</span><span class="p">)</span>
      <span class="n">index</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__getattribute__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;index&quot;</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">attrs</span><span class="p">)</span>
        <span class="n">attrs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">attrs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">attrs</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">item</span><span class="p">])</span>
      <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
  <span class="n">attrs</span> <span class="o">=</span> <span class="p">[]</span>
  <span class="n">obj</span><span class="p">(</span><span class="n">Dummy</span><span class="p">(</span><span class="n">attrs</span><span class="p">))</span>
  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">attrs</span><span class="p">))</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_bool">
    <p>def <span class="ident">save_bool</span>(</p><p>self, obj)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_bool', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_bool" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_bool</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">obj</span> <span class="ow">and</span> <span class="n">NEWTRUE</span> <span class="ow">or</span> <span class="n">NEWFALSE</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">obj</span> <span class="ow">and</span> <span class="n">TRUE</span> <span class="ow">or</span> <span class="n">FALSE</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_buffer">
    <p>def <span class="ident">save_buffer</span>(</p><p>self, obj)</p>
    </div>
    

    
  
    <div class="desc"><p>Fallback to save_string</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_buffer', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_buffer" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_buffer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Fallback to save_string&quot;&quot;&quot;</span>
  <span class="n">Pickler</span><span class="o">.</span><span class="n">save_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_builtin_function">
    <p>def <span class="ident">save_builtin_function</span>(</p><p>self, obj)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_builtin_function', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_builtin_function" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_builtin_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
  <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">__module__</span> <span class="ow">is</span> <span class="s2">&quot;__builtin__&quot;</span><span class="p">:</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_global</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_function</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_codeobject">
    <p>def <span class="ident">save_codeobject</span>(</p><p>self, obj)</p>
    </div>
    

    
  
    <div class="desc"><p>Save a code object</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_codeobject', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_codeobject" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_codeobject</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Save a code object</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">co_argcount</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_kwonlyargcount</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_nlocals</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_stacksize</span><span class="p">,</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">co_flags</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_code</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_consts</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_names</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">,</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">co_filename</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_firstlineno</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_lnotab</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_freevars</span><span class="p">,</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">co_cellvars</span>
    <span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">co_argcount</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_nlocals</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_stacksize</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_flags</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_code</span><span class="p">,</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">co_consts</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_names</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_varnames</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_filename</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_name</span><span class="p">,</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">co_firstlineno</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_lnotab</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_freevars</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">co_cellvars</span>
    <span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">CodeType</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_dict">
    <p>def <span class="ident">save_dict</span>(</p><p>self, obj)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_dict', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_dict" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="n">write</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin</span><span class="p">:</span>
        <span class="n">write</span><span class="p">(</span><span class="n">EMPTY_DICT</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>   <span class="c1"># proto 0 -- can&#39;t use EMPTY_DICT</span>
        <span class="n">write</span><span class="p">(</span><span class="n">MARK</span> <span class="o">+</span> <span class="n">DICT</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">memoize</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_batch_setitems</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">iteritems</span><span class="p">())</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_empty_tuple">
    <p>def <span class="ident">save_empty_tuple</span>(</p><p>self, obj)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_empty_tuple', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_empty_tuple" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_empty_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">EMPTY_TUPLE</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_file">
    <p>def <span class="ident">save_file</span>(</p><p>self, obj)</p>
    </div>
    

    
  
    <div class="desc"><p>Save a file</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_file', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_file" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span> <span class="c1"># pylint: disable=too-many-branches</span>
  <span class="sd">&quot;&quot;&quot;Save a file&quot;&quot;&quot;</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">StringIO</span> <span class="kn">as</span> <span class="nn">pystringIO</span> <span class="c1">#we can&#39;t use cStringIO as it lacks the name attribute</span>
  <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">io</span> <span class="kn">as</span> <span class="nn">pystringIO</span> <span class="c1"># pylint: disable=reimported</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">)</span> <span class="ow">or</span>  <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;mode&#39;</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Cannot pickle files that do not map to an actual file&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="nb">getattr</span><span class="p">,</span> <span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s1">&#39;stdout&#39;</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="nb">getattr</span><span class="p">,</span> <span class="p">(</span><span class="n">sys</span><span class="p">,</span> <span class="s1">&#39;stderr&#39;</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Cannot pickle standard input&quot;</span><span class="p">)</span>
  <span class="k">if</span>  <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;isatty&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">isatty</span><span class="p">():</span>
    <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Cannot pickle files that map to tty objects&quot;</span><span class="p">)</span>
  <span class="k">if</span> <span class="s1">&#39;r&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">mode</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Cannot pickle files that are not opened for reading&quot;</span><span class="p">)</span>
  <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">name</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">fsize</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">st_size</span>
  <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Cannot pickle file </span><span class="si">%s</span><span class="s2"> as it cannot be stat&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">closed</span><span class="p">:</span>
    <span class="c1">#create an empty closed string io</span>
    <span class="n">retval</span> <span class="o">=</span> <span class="n">pystringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">retval</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
  <span class="k">elif</span> <span class="ow">not</span> <span class="n">fsize</span><span class="p">:</span> <span class="c1">#empty file</span>
    <span class="n">retval</span> <span class="o">=</span> <span class="n">pystringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">tmpfile</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
      <span class="n">tst</span> <span class="o">=</span> <span class="n">tmpfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Cannot pickle file </span><span class="si">%s</span><span class="s2"> as it cannot be read&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">tmpfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">tst</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span>
          <span class="s2">&quot;Cannot pickle file </span><span class="si">%s</span><span class="s2"> as it does not appear to map to a physical, real file&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="n">tmpfile</span> <span class="o">=</span> <span class="nb">file</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
      <span class="n">contents</span> <span class="o">=</span> <span class="n">tmpfile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
      <span class="n">tmpfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Cannot pickle file </span><span class="si">%s</span><span class="s2"> as it cannot be read&quot;</span> <span class="o">%</span> <span class="n">name</span><span class="p">)</span>
    <span class="n">retval</span> <span class="o">=</span> <span class="n">pystringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">contents</span><span class="p">)</span>
    <span class="n">curloc</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
    <span class="n">retval</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">curloc</span><span class="p">)</span>
  <span class="n">retval</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">retval</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">memoize</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_float">
    <p>def <span class="ident">save_float</span>(</p><p>self, obj, pack=&lt;built-in function pack&gt;)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_float', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_float" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_float</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">pack</span><span class="o">=</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">BINFLOAT</span> <span class="o">+</span> <span class="n">pack</span><span class="p">(</span><span class="s1">&#39;&gt;d&#39;</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">FLOAT</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_function">
    <p>def <span class="ident">save_function</span>(</p><p>self, obj, name=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Registered with the dispatch to handle all function types.
Determines what kind of function obj is (e.g. lambda, defined at
interactive prompt, etc) and handles the pickling appropriately.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_function', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_function" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_function</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot; Registered with the dispatch to handle all function types.</span>
<span class="sd">  Determines what kind of function obj is (e.g. lambda, defined at</span>
<span class="sd">  interactive prompt, etc) and handles the pickling appropriately.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">write</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span>
  <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__name__</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="c1"># whichmodule() could fail, see</span>
    <span class="c1"># https://bitbucket.org/gutworth/six/issues/63/importing-six-breaks-pickling</span>
    <span class="n">modname</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">whichmodule</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
  <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
    <span class="n">modname</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="c1"># print(&#39;which gives %s %s %s&#39; % (modname, obj, name))</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">themodule</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">modname</span><span class="p">]</span>
  <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
    <span class="c1"># eval&#39;d items such as namedtuple give invalid items for their function __module__</span>
    <span class="n">modname</span> <span class="o">=</span> <span class="s1">&#39;__main__&#39;</span>
  <span class="k">if</span> <span class="n">modname</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">themodule</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="k">if</span> <span class="n">themodule</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">themodule</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">themodule</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="n">obj</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_global</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
  <span class="c1"># if func is lambda, def&#39;ed at prompt, is in main, or is nested, then</span>
  <span class="c1"># we&#39;ll pickle the actual function object rather than simply saving a</span>
  <span class="c1"># reference (as is done in default pickler), via save_function_tuple.</span>
  <span class="k">if</span> <span class="n">islambda</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">__code__</span><span class="o">.</span><span class="n">co_filename</span> <span class="o">==</span> <span class="s1">&#39;&lt;stdin&gt;&#39;</span> <span class="ow">or</span> <span class="n">themodule</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="c1">#print(&quot;save global&quot;, islambda(obj), obj.__code__.co_filename, modname, themodule)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_function_tuple</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">return</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="c1"># func is nested</span>
    <span class="n">klass</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">themodule</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">klass</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">klass</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">obj</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">save_function_tuple</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
      <span class="k">return</span>
  <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
    <span class="c1"># essentially save_reduce, but workaround needed to avoid recursion</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">_restore_attr</span><span class="p">)</span>
    <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">MARK</span> <span class="o">+</span> <span class="n">pickle</span><span class="o">.</span><span class="n">GLOBAL</span> <span class="o">+</span> <span class="n">modname</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">memoize</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
    <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">TUPLE</span> <span class="o">+</span> <span class="n">pickle</span><span class="o">.</span><span class="n">REDUCE</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">GLOBAL</span> <span class="o">+</span> <span class="n">modname</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">name</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">memoize</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_function_tuple">
    <p>def <span class="ident">save_function_tuple</span>(</p><p>self, func)</p>
    </div>
    

    
  
    <div class="desc"><p>Pickles an actual func object.
A func comprises: code, globals, defaults, closure, and dict.  We
extract and save these, injecting reducing functions at certain points
to recreate the func object.  Keep in mind that some of these pieces
can contain a ref to the func itself.  Thus, a naive save on these
pieces could trigger an infinite loop of save's.  To get around that,
we first create a skeleton func object using just the code (this is
safe, since this won't contain a ref to the func), and memoize it as
soon as it's created.  The other stuff can then be filled in later.</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_function_tuple', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_function_tuple" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_function_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;  Pickles an actual func object.</span>
<span class="sd">  A func comprises: code, globals, defaults, closure, and dict.  We</span>
<span class="sd">  extract and save these, injecting reducing functions at certain points</span>
<span class="sd">  to recreate the func object.  Keep in mind that some of these pieces</span>
<span class="sd">  can contain a ref to the func itself.  Thus, a naive save on these</span>
<span class="sd">  pieces could trigger an infinite loop of save&#39;s.  To get around that,</span>
<span class="sd">  we first create a skeleton func object using just the code (this is</span>
<span class="sd">  safe, since this won&#39;t contain a ref to the func), and memoize it as</span>
<span class="sd">  soon as it&#39;s created.  The other stuff can then be filled in later.</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="n">save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span>
  <span class="n">write</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span>
  <span class="n">code</span><span class="p">,</span> <span class="n">f_globals</span><span class="p">,</span> <span class="n">defaults</span><span class="p">,</span> <span class="n">closure</span><span class="p">,</span> <span class="n">dct</span><span class="p">,</span> <span class="n">base_globals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_func_data</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
  <span class="n">save</span><span class="p">(</span><span class="n">_fill_function</span><span class="p">)</span>  <span class="c1"># skeleton function updater</span>
  <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">MARK</span><span class="p">)</span>    <span class="c1"># beginning of tuple that _fill_function expects</span>
  <span class="c1"># create a skeleton function object and memoize it</span>
  <span class="n">save</span><span class="p">(</span><span class="n">_make_skel_func</span><span class="p">)</span>
  <span class="n">save</span><span class="p">((</span><span class="n">code</span><span class="p">,</span> <span class="n">closure</span><span class="p">,</span> <span class="n">base_globals</span><span class="p">))</span>
  <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">REDUCE</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">memoize</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
  <span class="c1"># save the rest of the func data needed by _fill_function</span>
  <span class="n">save</span><span class="p">(</span><span class="n">f_globals</span><span class="p">)</span>
  <span class="n">save</span><span class="p">(</span><span class="n">defaults</span><span class="p">)</span>
  <span class="n">save</span><span class="p">(</span><span class="n">dct</span><span class="p">)</span>
  <span class="n">save</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">__module__</span><span class="p">)</span>
  <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">TUPLE</span><span class="p">)</span>
  <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">REDUCE</span><span class="p">)</span>  <span class="c1"># applies _fill_function on the tuple</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_global">
    <p>def <span class="ident">save_global</span>(</p><p>self, obj, name=None, pack=&lt;built-in function pack&gt;)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_global', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_global" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_global</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">pack</span><span class="o">=</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">):</span> <span class="c1"># pylint: disable=too-many-branches</span>
  <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">__module__</span> <span class="o">==</span> <span class="s2">&quot;__builtin__&quot;</span> <span class="ow">or</span> <span class="n">obj</span><span class="o">.</span><span class="n">__module__</span> <span class="o">==</span> <span class="s2">&quot;builtins&quot;</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">_BUILTIN_TYPE_NAMES</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_builtin_type</span><span class="p">,</span> <span class="p">(</span><span class="n">_BUILTIN_TYPE_NAMES</span><span class="p">[</span><span class="n">obj</span><span class="p">],),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__name__</span>
  <span class="n">modname</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;__module__&quot;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">modname</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
      <span class="c1"># whichmodule() could fail, see</span>
      <span class="c1"># https://bitbucket.org/gutworth/six/issues/63/importing-six-breaks-pickling</span>
      <span class="n">modname</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">whichmodule</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
      <span class="n">modname</span> <span class="o">=</span> <span class="s1">&#39;__main__&#39;</span>
  <span class="k">if</span> <span class="n">modname</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">themodule</span> <span class="o">=</span> <span class="bp">None</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="nb">__import__</span><span class="p">(</span><span class="n">modname</span><span class="p">)</span>
    <span class="n">themodule</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">modname</span><span class="p">]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">themodule</span><span class="p">)</span>
  <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">themodule</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">themodule</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="ow">is</span> <span class="n">obj</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">Pickler</span><span class="o">.</span><span class="n">save_global</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
  <span class="n">typ</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">typ</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">obj</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ClassType</span><span class="p">)):</span>
    <span class="n">d</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>  <span class="c1"># copy dict proxy to a dict</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;__dict__&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">),</span> <span class="nb">property</span><span class="p">):</span>
      <span class="c1"># don&#39;t extract dict that are properties</span>
      <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;__dict__&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;__weakref__&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="c1"># hack as __new__ is stored differently in the __dict__</span>
    <span class="n">new_override</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;__new__&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">new_override</span><span class="p">:</span>
      <span class="n">d</span><span class="p">[</span><span class="s1">&#39;__new__&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__new__</span>
    <span class="c1"># workaround for namedtuple (hijacked by PySpark)</span>
    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;_is_namedtuple_&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_load_namedtuple</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">_fields</span><span class="p">))</span>
      <span class="k">return</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">_load_class</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">__bases__</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;__doc__&quot;</span><span class="p">:</span> <span class="n">obj</span><span class="o">.</span><span class="n">__doc__</span><span class="p">}),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
    <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;__doc__&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="c1"># handle property and staticmethod</span>
    <span class="n">dd</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">property</span><span class="p">):</span>
        <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;property&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span><span class="o">.</span><span class="n">fget</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">fset</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">fdel</span><span class="p">,</span> <span class="n">v</span><span class="o">.</span><span class="n">__doc__</span><span class="p">)</span>
      <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">staticmethod</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;__func__&#39;</span><span class="p">):</span>
        <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;staticmethod&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">__func__</span>
      <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">classmethod</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="s1">&#39;__func__&#39;</span><span class="p">):</span>
        <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;classmethod&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">__func__</span>
      <span class="n">dd</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">dd</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">TUPLE2</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">REDUCE</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Can&#39;t pickle </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">obj</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_inst">
    <p>def <span class="ident">save_inst</span>(</p><p>self, obj)</p>
    </div>
    

    
  
    <div class="desc"><p>Inner logic to save instance. Based off pickle.save_inst
Supports <strong>transient</strong></p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_inst', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_inst" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_inst</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Inner logic to save instance. Based off pickle.save_inst</span>
<span class="sd">  Supports __transient__&quot;&quot;&quot;</span>
  <span class="n">cls</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__class__</span>
  <span class="n">memo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memo</span>
  <span class="n">write</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span>
  <span class="n">save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span>
  <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;__getinitargs__&#39;</span><span class="p">):</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__getinitargs__</span><span class="p">()</span>
    <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>  <span class="c1"># assert it&#39;s a sequence</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">_keep_alive</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="c1"># pylint: disable=protected-access</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">()</span>
  <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">MARK</span><span class="p">)</span>
  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin</span><span class="p">:</span>
    <span class="n">save</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
      <span class="n">save</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">OBJ</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
      <span class="n">save</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">INST</span> <span class="o">+</span> <span class="n">cls</span><span class="o">.</span><span class="n">__module__</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">cls</span><span class="o">.</span><span class="n">__name__</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">memoize</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
  <span class="k">try</span><span class="p">:</span>
    <span class="n">getstate</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__getstate__</span>
  <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
    <span class="n">stuff</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__dict__</span>
    <span class="c1">#remove items if transient</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;__transient__&#39;</span><span class="p">):</span>
      <span class="n">transient</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__transient__</span>
      <span class="n">stuff</span> <span class="o">=</span> <span class="n">stuff</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
      <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">stuff</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">transient</span><span class="p">:</span>
          <span class="k">del</span> <span class="n">stuff</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">stuff</span> <span class="o">=</span> <span class="n">getstate</span><span class="p">()</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">_keep_alive</span><span class="p">(</span><span class="n">stuff</span><span class="p">,</span> <span class="n">memo</span><span class="p">)</span> <span class="c1"># pylint: disable=protected-access</span>
  <span class="n">save</span><span class="p">(</span><span class="n">stuff</span><span class="p">)</span>
  <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">BUILD</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_instancemethod">
    <p>def <span class="ident">save_instancemethod</span>(</p><p>self, obj)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_instancemethod', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_instancemethod" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_instancemethod</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
  <span class="c1"># Memoization rarely is ever useful due to python bounding</span>
  <span class="k">if</span> <span class="n">PY3</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__func__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">__self__</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span>
        <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__func__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">__self__</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">__self__</span><span class="o">.</span><span class="n">__class__</span><span class="p">),</span>
        <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_int">
    <p>def <span class="ident">save_int</span>(</p><p>self, obj, pack=&lt;built-in function pack&gt;)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_int', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_int" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_int</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">pack</span><span class="o">=</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin</span><span class="p">:</span>
        <span class="c1"># If the int is small enough to fit in a signed 4-byte 2&#39;s-comp</span>
        <span class="c1"># format, we can store it more efficiently than the general</span>
        <span class="c1"># case.</span>
        <span class="c1"># First one- and two-byte unsigned ints:</span>
        <span class="k">if</span> <span class="n">obj</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="o">&lt;=</span> <span class="mh">0xff</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">BININT1</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">obj</span> <span class="o">&lt;=</span> <span class="mh">0xffff</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%c%c%c</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">BININT2</span><span class="p">,</span> <span class="n">obj</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">obj</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">))</span>
                <span class="k">return</span>
        <span class="c1"># Next check for 4-byte signed ints:</span>
        <span class="n">high_bits</span> <span class="o">=</span> <span class="n">obj</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span>  <span class="c1"># note that Python shift sign-extends</span>
        <span class="k">if</span> <span class="n">high_bits</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">high_bits</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="c1"># All high bits are copies of bit 2**31, so the value</span>
            <span class="c1"># fits in a 4-byte signed int.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">BININT</span> <span class="o">+</span> <span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;i&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">))</span>
            <span class="k">return</span>
    <span class="c1"># Text pickle, or int too big to fit in signed 4-byte format.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">INT</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_itemgetter">
    <p>def <span class="ident">save_itemgetter</span>(</p><p>self, obj)</p>
    </div>
    

    
  
    <div class="desc"><p>itemgetter serializer (needed for namedtuple support)</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_itemgetter', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_itemgetter" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_itemgetter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;itemgetter serializer (needed for namedtuple support)&quot;&quot;&quot;</span>
  <span class="k">class</span> <span class="nc">Dummy</span><span class="p">:</span> <span class="c1"># pylint: disable=old-style-class</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
      <span class="k">pass</span>
    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
      <span class="k">return</span> <span class="n">item</span>
  <span class="n">items</span> <span class="o">=</span> <span class="n">obj</span><span class="p">(</span><span class="n">Dummy</span><span class="p">())</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
    <span class="n">items</span> <span class="o">=</span> <span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="p">)</span>
  <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">itemgetter</span><span class="p">,</span> <span class="n">items</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_list">
    <p>def <span class="ident">save_list</span>(</p><p>self, obj)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_list', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_list" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="n">write</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin</span><span class="p">:</span>
        <span class="n">write</span><span class="p">(</span><span class="n">EMPTY_LIST</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>   <span class="c1"># proto 0 -- can&#39;t use EMPTY_LIST</span>
        <span class="n">write</span><span class="p">(</span><span class="n">MARK</span> <span class="o">+</span> <span class="n">LIST</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">memoize</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_batch_appends</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_long">
    <p>def <span class="ident">save_long</span>(</p><p>self, obj, pack=&lt;built-in function pack&gt;)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_long', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_long" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_long</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">pack</span><span class="o">=</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="nb">bytes</span> <span class="o">=</span> <span class="n">encode_long</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">bytes</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">LONG1</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="nb">bytes</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">LONG4</span> <span class="o">+</span> <span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;i&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="nb">bytes</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">LONG</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_memoryview">
    <p>def <span class="ident">save_memoryview</span>(</p><p>self, obj)</p>
    </div>
    

    
  
    <div class="desc"><p>Fallback to save_string</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_memoryview', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_memoryview" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_memoryview</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Fallback to save_string&quot;&quot;&quot;</span>
  <span class="n">Pickler</span><span class="o">.</span><span class="n">save_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_module">
    <p>def <span class="ident">save_module</span>(</p><p>self, obj)</p>
    </div>
    

    
  
    <div class="desc"><p>Save a module as an import</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_module', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_module" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_module</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">  Save a module as an import</span>
<span class="sd">  &quot;&quot;&quot;</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">subimport</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">__name__</span><span class="p">,),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_none">
    <p>def <span class="ident">save_none</span>(</p><p>self, obj)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_none', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_none" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_none</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">NONE</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_partial">
    <p>def <span class="ident">save_partial</span>(</p><p>self, obj)</p>
    </div>
    

    
  
    <div class="desc"><p>Partial objects do not serialize correctly in python2.x -- this fixes the bugs</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_partial', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_partial" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_partial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Partial objects do not serialize correctly in python2.x -- this fixes the bugs&quot;&quot;&quot;</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_genpartial</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">keywords</span><span class="p">))</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_pers">
    <p>def <span class="ident">save_pers</span>(</p><p>self, pid)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_pers', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_pers" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_pers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">):</span>
    <span class="c1"># Save a persistent id reference</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">BINPERSID</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">PERSID</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_property">
    <p>def <span class="ident">save_property</span>(</p><p>self, obj)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_property', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_property" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
  <span class="c1"># properties not correctly saved in python</span>
  <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="nb">property</span><span class="p">,</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">fget</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">fset</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">fdel</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">__doc__</span><span class="p">),</span> <span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_reduce">
    <p>def <span class="ident">save_reduce</span>(</p><p>self, func, args, state=None, listitems=None, dictitems=None, obj=None)</p>
    </div>
    

    
  
    <div class="desc"><p>Modified to support <strong>transient</strong> on new objects
Change only affects protocol level 2 (which is always used by PiCloud</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_reduce', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_reduce" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_reduce</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="c1"># pylint: disable=too-many-branches</span>
                <span class="n">listitems</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">dictitems</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Modified to support __transient__ on new objects</span>
<span class="sd">  Change only affects protocol level 2 (which is always used by PiCloud&quot;&quot;&quot;</span>
  <span class="c1"># Assert that args is a tuple or None</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;args from reduce() should be a tuple&quot;</span><span class="p">)</span>
  <span class="c1"># Assert that func is callable</span>
  <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s1">&#39;__call__&#39;</span><span class="p">):</span>
    <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;func from reduce should be callable&quot;</span><span class="p">)</span>
  <span class="n">save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span>
  <span class="n">write</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span>
  <span class="c1"># Protocol 2 special case: if func&#39;s name is __newobj__, use NEWOBJ</span>
  <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;__newobj__&quot;</span><span class="p">:</span>
    <span class="c1">#Added fix to allow transient</span>
    <span class="n">cls</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="s2">&quot;__new__&quot;</span><span class="p">):</span>
      <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span>
          <span class="s2">&quot;args[0] from __newobj__ args has no __new__&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">cls</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">__class__</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span>
          <span class="s2">&quot;args[0] from __newobj__ args has the wrong class&quot;</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">save</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
    <span class="c1">#Don&#39;t pickle transient entries</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s1">&#39;__transient__&#39;</span><span class="p">):</span>
      <span class="n">transient</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__transient__</span>
      <span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
      <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">transient</span><span class="p">:</span>
          <span class="k">del</span> <span class="n">state</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
    <span class="n">save</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">NEWOBJ</span><span class="p">)</span>
  <span class="k">else</span><span class="p">:</span>
    <span class="n">save</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="n">save</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">REDUCE</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">memoize</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
  <span class="c1"># More new special cases (that work with older protocols as</span>
  <span class="c1"># well): when __reduce__ returns a tuple with 4 or 5 items,</span>
  <span class="c1"># the 4th and 5th item should be iterators that provide list</span>
  <span class="c1"># items and dict items (as (key, value) tuples), or None.</span>
  <span class="k">if</span> <span class="n">listitems</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_batch_appends</span><span class="p">(</span><span class="n">listitems</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">dictitems</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_batch_setitems</span><span class="p">(</span><span class="n">dictitems</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">state</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">save</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
    <span class="n">write</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">BUILD</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_string">
    <p>def <span class="ident">save_string</span>(</p><p>self, obj, pack=&lt;built-in function pack&gt;)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_string', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_string" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_string</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">pack</span><span class="o">=</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">SHORT_BINSTRING</span> <span class="o">+</span> <span class="nb">chr</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">obj</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">BINSTRING</span> <span class="o">+</span> <span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;i&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">obj</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">STRING</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">memoize</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_tuple">
    <p>def <span class="ident">save_tuple</span>(</p><p>self, obj)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_tuple', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_tuple" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_tuple</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="n">write</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">write</span>
    <span class="n">proto</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">proto</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">proto</span><span class="p">:</span>
            <span class="n">write</span><span class="p">(</span><span class="n">EMPTY_TUPLE</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">write</span><span class="p">(</span><span class="n">MARK</span> <span class="o">+</span> <span class="n">TUPLE</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="n">save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save</span>
    <span class="n">memo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">memo</span>
    <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span> <span class="mi">3</span> <span class="ow">and</span> <span class="n">proto</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
            <span class="n">save</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
        <span class="c1"># Subtle.  Same as in the big comment below.</span>
        <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">in</span> <span class="n">memo</span><span class="p">:</span>
            <span class="n">get</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">memo</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">)][</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">write</span><span class="p">(</span><span class="n">POP</span> <span class="o">*</span> <span class="n">n</span> <span class="o">+</span> <span class="n">get</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">write</span><span class="p">(</span><span class="n">_tuplesize2code</span><span class="p">[</span><span class="n">n</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">memoize</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="c1"># proto 0 or proto 1 and tuple isn&#39;t empty, or proto &gt; 1 and tuple</span>
    <span class="c1"># has more than 3 elements.</span>
    <span class="n">write</span><span class="p">(</span><span class="n">MARK</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
        <span class="n">save</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">in</span> <span class="n">memo</span><span class="p">:</span>
        <span class="c1"># Subtle.  d was not in memo when we entered save_tuple(), so</span>
        <span class="c1"># the process of saving the tuple&#39;s elements must have saved</span>
        <span class="c1"># the tuple itself:  the tuple is recursive.  The proper action</span>
        <span class="c1"># now is to throw away everything we put on the stack, and</span>
        <span class="c1"># simply GET the tuple (it&#39;s already constructed).  This check</span>
        <span class="c1"># could have been done in the &quot;for element&quot; loop instead, but</span>
        <span class="c1"># recursive tuples are a rare thing.</span>
        <span class="n">get</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">memo</span><span class="p">[</span><span class="nb">id</span><span class="p">(</span><span class="n">obj</span><span class="p">)][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">proto</span><span class="p">:</span>
            <span class="n">write</span><span class="p">(</span><span class="n">POP_MARK</span> <span class="o">+</span> <span class="n">get</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>   <span class="c1"># proto 0 -- POP_MARK not available</span>
            <span class="n">write</span><span class="p">(</span><span class="n">POP</span> <span class="o">*</span> <span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">get</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="c1"># No recursion.</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">TUPLE</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">memoize</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_ufunc">
    <p>def <span class="ident">save_ufunc</span>(</p><p>self, obj)</p>
    </div>
    

    
  
    <div class="desc"><p>Hack function for saving numpy ufunc objects</p></div>
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_ufunc', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_ufunc" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_ufunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
  <span class="sd">&quot;&quot;&quot;Hack function for saving numpy ufunc objects&quot;&quot;&quot;</span>
  <span class="n">name</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">__name__</span>
  <span class="n">numpy_tst_mods</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;numpy&#39;</span><span class="p">,</span> <span class="s1">&#39;scipy.special&#39;</span><span class="p">]</span>
  <span class="k">for</span> <span class="n">tst_mod_name</span> <span class="ow">in</span> <span class="n">numpy_tst_mods</span><span class="p">:</span>
    <span class="n">tst_mod</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">tst_mod_name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tst_mod</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">tst_mod</span><span class="o">.</span><span class="n">__dict__</span><span class="p">:</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_reduce</span><span class="p">(</span><span class="n">_getobject</span><span class="p">,</span> <span class="p">(</span><span class="n">tst_mod_name</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>
  <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span>
      <span class="s1">&#39;cannot save </span><span class="si">%s</span><span class="s1">. Cannot resolve what module it is defined in&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_unicode">
    <p>def <span class="ident">save_unicode</span>(</p><p>self, obj, pack=&lt;built-in function pack&gt;)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_unicode', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_unicode" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_unicode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">pack</span><span class="o">=</span><span class="n">struct</span><span class="o">.</span><span class="n">pack</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin</span><span class="p">:</span>
        <span class="n">encoding</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">encoding</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">BINUNICODE</span> <span class="o">+</span> <span class="n">pack</span><span class="p">(</span><span class="s2">&quot;&lt;i&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span> <span class="o">+</span> <span class="n">encoding</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">u005c&quot;</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">u000a&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">UNICODE</span> <span class="o">+</span> <span class="n">obj</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;raw-unicode-escape&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">memoize</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</pre></div>

  </div>
</div>

  </div>
  
            
  <div class="item">
    <div class="name def" id="heronpy.api.cloudpickle.CloudPickler.save_unsupported">
    <p>def <span class="ident">save_unsupported</span>(</p><p>self, obj)</p>
    </div>
    

    
  
  <div class="source_cont">
  <p class="source_link"><a href="javascript:void(0);" onclick="toggle('source-heronpy.api.cloudpickle.CloudPickler.save_unsupported', this);">Show source &equiv;</a></p>
  <div id="source-heronpy.api.cloudpickle.CloudPickler.save_unsupported" class="source">
    <div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">save_unsupported</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span> <span class="c1"># pylint: disable=no-self-use</span>
  <span class="k">raise</span> <span class="n">pickle</span><span class="o">.</span><span class="n">PicklingError</span><span class="p">(</span><span class="s2">&quot;Cannot pickle objects of type </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">))</span>
</pre></div>

  </div>
</div>

  </div>
  
      </div>
      </div>

  </section>

    </article>
  <div class="clear"> </div>
  <footer id="footer">
    <p>
      Documentation generated by
      <a href="https://github.com/BurntSushi/pdoc">pdoc 0.3.2</a>
    </p>

    <p>pdoc is in the public domain with the
      <a href="http://unlicense.org">UNLICENSE</a></p>

    <p>Design by <a href="http://nadh.in">Kailash Nadh</a></p>
  </footer>
</div>
</body>
</html>
